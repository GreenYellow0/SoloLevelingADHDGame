<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solo Leveling System</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');

    :root {
      --bg-dark: #0A101A;
      --panel-gradient: linear-gradient(145deg, rgba(27, 34, 48, 0.9), rgba(17, 22, 32, 0.95));
      --system-blue: #0084ff;
      --system-blue-light: #69b4ff;
      --border-color: rgba(0, 132, 255, 0.3);
      --glow-color: rgba(0, 132, 255, 0.4);
      --notification-quest: rgba(0, 132, 255, 0.85);
      --notification-levelup: rgba(255, 215, 0, 0.85);
      --text-primary: #EAEAEA;
      --text-secondary: #A0A0B0;
      --xp-fill: var(--system-blue);
      --xp-bg: #2A2A3A;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      background-image: radial-gradient(circle at top left, rgba(0, 132, 255, 0.05), transparent 40%);
      background-attachment: fixed;
    }

    h2 {
      color: var(--text-primary);
      border-bottom: 2px solid var(--system-blue);
      padding-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 600;
      text-shadow: 0 0 8px rgba(0, 132, 255, 0.3);
    }
    h3 {
      color: var(--system-blue-light);
      font-weight: 600;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 5px;
      margin-top: 30px;
    }

    /* --- Hoofdlayout & Navigatie --- */
    .xp-bar-container {
      padding: 10px 20px;
      background: rgba(10, 16, 26, 0.8);
      border-bottom: 1px solid var(--border-color);
    }
    .nav {
      display: flex;
      justify-content: center;
      gap: 5px;
      padding: 10px;
      background-color: #05080D;
      flex-wrap: wrap;
    }
    .nav button, .nav input[type="file"] {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      background: transparent;
      color: var(--text-secondary);
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 0;
      transition: all 0.3s ease;
      position: relative;
    }
    .nav button:hover { color: var(--system-blue); }
    .nav button::after {
      content: ''; position: absolute; bottom: 0; left: 50%;
      transform: translateX(-50%); width: 0; height: 2px;
      background: var(--system-blue); transition: width 0.3s ease;
    }
    .nav button:hover::after { width: 70%; }

    /* --- Secties en Panelen --- */
    .section { display: none; max-width: 800px; margin: auto; padding: 20px; }
    .active { display: block; }

    .panel, .modal-content {
      background: var(--panel-gradient);
      backdrop-filter: blur(3px);
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 5px 25px rgba(0,0,0,0.3);
      clip-path: polygon(0 15px, 15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
    }

    /* --- XP Bar --- */
    .xp-bar {
      flex: 1; background-color: var(--xp-bg);
      background-image: linear-gradient(45deg, rgba(255,255,255,0.03) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.03) 50%, rgba(255,255,255,0.03) 75%, transparent 75%, transparent);
      background-size: 20px 20px; border-radius: 2px;
      overflow: hidden; height: 25px; border: 1px solid var(--border-color);
      padding: 2px; position: relative;
    }
    .xp-fill {
      height: 100%; background: var(--xp-fill); border-radius: 1px;
      text-align: right; padding-right: 10px; color: #05080D;
      font-weight: bold; font-size: 14px; line-height: 21px;
      transition: width 0.5s ease-in-out; position: relative;
      box-shadow: inset 0 0 8px rgba(0, 200, 255, 0.7), 0 0 10px var(--glow-color);
      overflow: hidden;
    }
    .xp-fill::before {
      content: ''; position: absolute; top: 0; left: 0;
      width: 100%; height: 50%;
      background: linear-gradient(to bottom, rgba(255,255,255,0.5), rgba(255,255,255,0));
      opacity: 0.8;
    }

    /* --- LIJSTEN (Quests, etc.) --- */
    ul { list-style: none; padding: 0; }
    .quest-list li, #gate-log-list li {
      background: rgba(27, 34, 48, 0.4); padding: 15px; margin: 8px 0;
      cursor: pointer; border-left: 3px solid var(--border-color);
      display: flex; justify-content: space-between; align-items: center;
      transition: all 0.2s ease; border-radius: 4px;
    }
    .quest-list li:hover {
      background: rgba(0, 132, 255, 0.15);
      border-left-color: var(--system-blue);
    }
    .quest-list li.done {
      opacity: 0.4; text-decoration: line-through; cursor: default;
      background: transparent; border-left-color: #555;
    }
    #active-gates-list li button {
        background: var(--panel-bg); color: var(--system-blue-light);
        border: 1px solid var(--border-color); padding: 5px 15px; font-weight: 600;
        cursor: pointer; transition: all 0.2s ease; border-radius: 4px;
    }
    #active-gates-list li button:hover { background: var(--system-blue); color: #fff; }

    /* --- SHOP KNOPPEN --- */
    .shop-menu button, .shop-submenu button {
        font-family: 'Montserrat', sans-serif; background: var(--panel-bg);
        color: var(--text-primary); border: 1px solid var(--border-color);
        padding: 10px 20px; font-weight: 600; cursor: pointer;
        margin: 5px; transition: all 0.2s ease;
    }
    .shop-menu button:hover, .shop-submenu button:hover {
        background: var(--system-blue); border-color: var(--system-blue); color: #fff;
    }
    .shop-submenu { display: none; }
    .shop-submenu.active { display: block; }
    
    /* --- GATE KNOPPEN --- */
    #gate-selection-container { display: flex; flex-wrap: wrap; gap: 0; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; padding: 0; }
    #gate-selection-container h3 { width: 100%; margin: 15px; border-bottom: none; }
    #gate-selection-container button {
        flex-grow: 1; background: transparent; color: var(--text-secondary);
        border: none; border-right: 1px solid var(--border-color);
        padding: 12px 10px; font-weight: 600; cursor: pointer;
        transition: all 0.2s ease; border-radius: 0; margin: 0;
    }
    #gate-selection-container button:last-child { border-right: none; }
    #gate-selection-container button:hover:not(:disabled) { background: rgba(0, 132, 255, 0.15); color: var(--system-blue-light); }
    #gate-selection-container button:disabled { color: #444; background: rgba(10, 16, 26, 0.5); cursor: not-allowed; }
    .gate-timer { font-weight: bold; color: var(--system-blue-light); }

    /* --- CODEX --- */
    #gate-log-list li { display: block; cursor: default; }
    #gate-log-list li:hover { background: rgba(27, 34, 48, 0.4); border-left-color: var(--border-color); }
    .log-header { display: flex; justify-content: space-between; font-weight: bold; }
    .log-result-cleared { color: var(--system-blue-light); }
    .log-result-failed, .log-result-declined { color: #ff5555; }
    .log-body { font-size: 0.9em; color: var(--text-secondary); margin-top: 5px; }

    /* --- TRADING POST --- */
    #trading-post-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .trade-card {
        background: var(--panel-gradient); border: 1px solid var(--border-color);
        padding: 15px; margin: 0; display: flex; flex-direction: column;
        align-items: center; text-align: center; width: 180px;
        box-sizing: border-box; transition: all 0.3s ease;
        clip-path: polygon(0 10px, 10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
    }
    .trade-card:hover { transform: translateY(-5px); border-color: var(--system-blue); }
    .trade-card img { width: 60px; height: 60px; margin-bottom: 10px; image-rendering: pixelated; }
    .trade-card h4 { margin: 5px 0; color: var(--system-blue-light); }
    .trade-card .owned-amount { color: var(--text-secondary); font-size: 0.9em; margin-bottom: 10px; }
    .trade-card .trade-info { font-size: 0.8em; margin-bottom: 10px; font-style: italic; }
    .trade-card input { width: 80%; text-align: center; background: #0A101A; border: 1px solid var(--border-color); color: #fff; padding: 5px; margin-bottom: 10px; border-radius: 4px; }
    .trade-card button { background: var(--panel-bg); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 12px; font-weight: 600; cursor: pointer; width: 80%; transition: all 0.2s ease; }
    .trade-card button:hover:not(:disabled) { background: var(--system-blue); color: #fff; }
    .trade-card button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* --- STATUS PAGINA --- */
    .status-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; gap: 20px; text-align: center; }
    .status-main-stats { grid-column: 1 / -1; display: flex; justify-content: space-around; align-items: center; padding: 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border-color); }
    .status-main-stats .stat-block { display: flex; flex-direction: column; }
    .status-main-stats .stat-label { font-size: 1.2em; color: var(--text-secondary); text-transform: uppercase; }
    .status-main-stats .stat-value { font-size: 4em; font-weight: 700; color: #fff; text-shadow: 0 0 10px var(--glow-color); }
    .status-secondary-stats { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
    .status-secondary-stats .stat-block { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 4px; border: 1px solid var(--border-color); }
    .status-secondary-stats .stat-label { font-size: 1em; color: var(--text-secondary); }
    .status-secondary-stats .stat-value { font-size: 1.8em; color: var(--system-blue-light); font-weight: 600; }
    .ranks-info { grid-column: 1 / -1; font-size: 0.9em; color: var(--text-secondary); margin-top: 10px; }

    /* --- Tabellen (Info pagina) --- */
    .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .info-table th, .info-table td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
    .info-table th { background-color: #05080D; color: var(--system-blue); }
    .info-table tr:nth-child(even) { background-color: rgba(27, 34, 48, 0.4); }

    /* --- Modals --- */
    .modal {
      display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(10, 16, 26, 0.8); backdrop-filter: blur(5px);
      justify-content: center; align-items: center; z-index: 1000;
      visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0s 0.3s;
    }
    .modal.active { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }
    .modal-content { text-align: center; max-width: 90%; width: 450px; }
    .modal-content button { padding: 12px 25px; font-weight: bold; background: var(--system-blue); color: #fff; border: none; cursor: pointer; margin: 10px; }
    .modal-content button:hover { background: var(--system-blue-light); color: var(--bg-dark); }
    #gateModal .modal-content button.decline { background: #555; }
    #gateModal .modal-content button.decline:hover { background: #777; }

    /* --- Wapen/Item Kaartjes --- */
    .weapon-card-list { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .weapon-card, .item-card {
      background: var(--panel-gradient); border: 1px solid var(--border-color);
      padding: 15px; margin: 0; display: flex; flex-direction: column;
      align-items: center; text-align: center; width: 160px;
      box-sizing: border-box; transition: all 0.3s ease;
      clip-path: polygon(0 10px, 10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
    }
    .weapon-card:hover, .item-card:hover { transform: translateY(-5px); border-color: var(--system-blue); box-shadow: 0 0 15px rgba(0, 132, 255, 0.2); }
    .weapon-item-icon, .item-icon { width: 80px; height: 80px; margin-bottom: 10px; image-rendering: pixelated; background: rgba(0,0,0,0.3); border-radius: 4px; padding: 5px; }
    .weapon-card-name, .item-card-name { font-size: 1.1em; font-weight: bold; color: var(--system-blue); margin-bottom: 5px; }
    .weapon-card-rank, .item-card-cost-display, .weapon-card-cost { font-size: 0.9em; color: var(--system-blue-light); margin-bottom: 5px; }
    .weapon-card-ability, .item-card-effect { font-size: 0.8em; color: var(--text-secondary); font-style: italic; margin-bottom: 10px; min-height: 2.4em; }
    .weapon-card button, .item-card button { background: transparent; color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 12px; font-weight: 600; cursor: pointer; width: 100%; }
    .weapon-card button:hover:not(:disabled), .item-card button:hover:not(:disabled) { background: var(--system-blue); color: #fff; border-color: var(--system-blue); }
    .weapon-card button:disabled, .item-card button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* --- NOTIFICATIE SYSTEEM --- */
    #notification-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .notification { padding: 15px 20px; border-radius: 5px; color: #fff; font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.5); border-left: 5px solid; animation: slideIn 0.5s ease, fadeOut 0.5s ease 4.5s; }
    .notification.quest { background-color: var(--notification-quest); border-color: var(--system-blue-light); }
    .notification.level-up { background-color: rgba(255, 215, 0, 0.85); border-color: #FFD700; text-shadow: 0 0 5px #000; }
    .notification.streak { background: linear-gradient(45deg, #FFD700, #F0B400); border-color: #fff; text-shadow: 0 0 5px #000; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(10%); } }
  </style>
</head>
<body>
  <div class="xp-bar-container">
    <div class="xp-bar"><div class="xp-fill" id="xpFill">0 XP</div></div>
  </div>
  <div class="nav">
    <button onclick="showPage('status')">Status</button>
    <button onclick="showPage('quests')">Quests</button>
    <button onclick="showPage('gate')">Gate</button>
    <button onclick="showPage('tradingPost')">Trading Post</button> <!-- NIEUWE KNOP -->
    <button onclick="showPage('shop')">Shop</button>
    <button onclick="showPage('inventory')">Inventory</button>
    <button onclick="showPage('generalInfo')">Info</button>
    <button onclick="saveProgress()">Save Progress</button>
    <input type="file" onchange="loadProgress(event)">
  </div>

  <div id="status" class="section active">
    <h2>Status</h2>
    <div class="panel">
      <div class="status-grid">
        <div class="status-main-stats">
          <div class="stat-block"><span class="stat-label">Level</span><span class="stat-value" id="level">1</span></div>
          <div class="stat-block"><span class="stat-label">Rank</span><span class="stat-value" id="rank">F</span></div>
        </div>
        <div class="status-secondary-stats">
          <div class="stat-block"><span class="stat-label">Points</span><span class="stat-value" id="points">0</span></div>
          <div class="stat-block"><span class="stat-label">Gold</span><span class="stat-value" id="gold">0</span></div>
          <div class="stat-block"><span class="stat-label">Silver</span><span class="stat-value" id="silver">0</span></div>
        </div>
        <div class="ranks-info">Available Ranks: F, E, D, C, B, A, S, S+, S++</div>
      </div>
    </div>
  </div>

  <div id="quests" class="section">
    <h2>Daily Quests</h2><ul id="dailyList" class="quest-list"></ul>
    <h2>Daily Physical Quests</h2><ul id="dailyPhysicalList" class="quest-list"></ul>
    <h2>Special Quests</h2><ul id="specialList" class="quest-list"></ul>
    <h2>Streak Challenges</h2><ul id="streakList" class="quest-list"></ul>
  </div>

  <div id="gate" class="section">
    <h2>Gates</h2>
    <div id="gate-selection-container" class="panel"></div>
    <h3>Active Gates</h3>
    <ul id="active-gates-list" class="quest-list"></ul>
    <h3>Statistics</h3>
    <div class="panel">
        <p>Accepted Gates: <span id="gates-accepted">0</span></p>
        <p>Declined Gates: <span id="gates-declined">0</span></p>
    </div>
    <h3>Codex of Gates</h3>
    <ul id="gate-log-list"></ul>
  </div>

  <!-- NIEUWE TRADING POST PAGINA -->
  <div id="tradingPost" class="section">
    <h2>Trading Post</h2>
    <div class="panel">
        <p>Exchange items found in gates for valuable rewards.</p>
        <div id="trading-post-container">
            <!-- Trading cards will be generated here -->
        </div>
    </div>
  </div>

  <div id="shop" class="section">
    <h2>Shop</h2>
    <div class="panel shop-menu active">
      <p>You have <strong><span id="shopPoints">0</span> points</strong>, <strong><span id="shopGold">0</span> Gold</strong>, and <strong><span id="shopSilver">0</span> Silver</strong>.</p>
      <button onclick="showShopPage('rankUpgrades')">Rank Upgrades</button>
      <button onclick="showShopPage('itemShop')">Item Shop</button>
      <button onclick="showShopPage('weaponShop')">Weapon Shop</button>
    </div>
    <div id="rankUpgrades" class="panel shop-submenu"><ul id="rankUpgradeList" class="quest-list"></ul><button onclick="showShopPage('mainShop')">Back to Shop</button></div>
    <div id="itemShop" class="panel shop-submenu"><ul id="itemList" class="weapon-card-list"></ul><button onclick="showShopPage('mainShop')">Back to Shop</button></div>
    <div id="weaponShop" class="panel shop-submenu"><ul id="weaponList" class="weapon-card-list"></ul><button onclick="showShopPage('mainShop')">Back to Shop</button></div>
  </div>

  <div id="inventory" class="section">
    <h2>Inventory</h2>
    <div class="panel"><ul id="inventoryList" class="weapon-card-list"></ul></div>
  </div>

  <div id="generalInfo" class="section">
    <h2>Game Information & Progression Guide</h2>
    <div class="panel">
        <h3>Welcome, Adventurer!</h3>
        <p>This application is designed to help you track and gamify your daily habits and personal challenges. By completing quests, you earn **XP (Experience Points)**, **Points**, and **Gold**, allowing you to level up, increase your rank, and unlock special rewards!</p>
        <h3>Level & XP System</h3>
        <p>Your **Level** represents your overall progress and dedication. You earn XP by completing any type of quest. The amount of XP required to reach the next level increases as you level up, ensuring a balanced progression.</p>
        <p><strong>XP Needed per Level:</strong></p>
        <table class="info-table">
            <thead><tr><th>From Level</th><th>To Level</th><th>XP Needed</th><th>Cumulative XP</th></tr></thead>
            <tbody>
                <tr><td>1</td><td>2</td><td>200</td><td>200</td></tr>
                <tr><td>2</td><td>3</td><td>400</td><td>600</td></tr>
                <tr><td>3</td><td>4</td><td>600</td><td>1200</td></tr>
                <tr><td>4</td><td>5</td><td>800</td><td>2000</td></tr>
                <tr><td>5</td><td>6</td><td>1000</td><td>3000</td></tr>
                <tr><td>...</td><td>...</td><td>(Level * 200)</td><td>...</td></tr>
            </tbody>
        </table>
        <h3>Quests: Your Path to Power</h3>
        <ul>
            <li><strong>Daily Quests:</strong> These are your essential daily habits (e.g., brushing teeth, taking meds). They offer small amounts of XP and Points, but reset every day at midnight, rewarding consistency.</li>
            <li><strong>Daily Physical Quests:</strong> These are specific physical exercises like Yoga or Workouts. They also reset daily and reward consistent physical activity.</li> <li><strong>Special Quests:</strong> These are larger, one-time tasks (e.g., cleaning your desk, exercising). They offer substantial XP and Points, but are active for 3 days and refresh every 3 days with new challenges.</li>
            <li><strong>Streak Challenges:</strong> These are long-term achievements that reward your consistent completion of specific daily quests for a set number of consecutive days (e.g., brushing teeth 7 days in a row). They offer significant XP, Points, and are the primary way to earn **Gold**. Once completed, they cannot be done again.</li>
        </ul>
        <h3>Rank System: Ascend to Greater Heights!</h3>
        <p>Your **Rank** (from F to S++) signifies your mastery and provides a bonus to the XP and Points you earn from quests. Higher ranks mean faster progress!</p>
        <p><strong>Rank Upgrades:</strong> To advance to the next rank, you must meet two criteria:</p>
        <ol>
            <li>Reach a **specific minimum Level**.</li>
            <li>Pay a **specific amount of Points**.</li>
        </ol>
        <p>This ensures balanced growth – you need to be both experienced (Level) and active (Points) to climb the ranks.</p>
        <p><strong>Rank Upgrade Requirements:</strong></p>
        <table class="info-table">
            <thead><tr><th>From Rank</th><th>To Rank</th><th>Min. Level</th><th>Points Cost</th></tr></thead>
            <tbody id="rankUpgradeInfoTableBody"></tbody>
        </table>
        <h3>Currency: Points, Silver & Gold</h3>
        <ul>
            <li><strong>Points:</strong> Earned from all quests. Primarily used to upgrade your Rank, or can be used to purchase **Items** in the Item Shop.</li>
            <li><strong>Silver:</strong> A common currency used to purchase certain items, especially weapons for lower ranks (F-C) and some special **Items**. You can earn Silver by purchasing specific Items with Points.</li>
            <li><strong>Gold:</strong> A rare currency earned specifically from completing **Streak Challenges**. Gold is used to purchase valuable **Real-Life Rewards** and advanced weapons for higher ranks (B-S++). You can also earn Gold by purchasing specific Items with Points or Silver.</li>
        </ul>
        <h3>Item Shop: Strategic Purchases!</h3>
        <p>The Item Shop offers unique purchases that provide immediate benefits or help you convert lower-value currency into higher-value currency. These items are consumed upon purchase and do not appear in your Inventory.</p>
        <p>Current items available:</p>
        <ul>
            <li><strong>Diamond Item:</strong> Spend 100 Points to instantly gain 1 Gold. (Repeatable)</li>
            <li><strong>Mana Crystal:</strong> Spend 10 Points to instantly gain 50 Silver. (Repeatable)</li>
            <li><strong>Advanced Mana Crystal:</strong> Spend 1000 Silver to instantly gain 250 XP. (Repeatable)</li>
        </ul>
        <p>Strategically use these items to manage your resources and accelerate your progress!</p>
        <h3>Weapons: Enhance Your Collection!</h3>
        <p>Weapons are collectible items that you can purchase from the Weapon Shop using Silver or Gold. Each weapon is associated with a specific Rank. You must achieve that Rank before you can purchase the weapon. Collecting all weapons will grant you a significant bonus reward!</p>
        <p><strong>Weapon Costs and Requirements:</strong></p>
        <ul>
            <li>Weapons for **F-Rank through C-Rank** are purchased using **Silver**.</li>
            <li>Weapons for **B-Rank through S++-Rank** are purchased using **Gold**.</li>
        </ul>
        <p>Upon collecting **all** weapons, you will receive a grand bonus of <strong>2000 XP, 500 Points, 100 Gold, and 2000 Silver!</strong></p>
    </div>
  </div>

  <div class="modal" id="questModal">
    <div class="modal-content panel"><p id="modalText"></p><button onclick="confirmQuest(true)">Yes</button><button onclick="confirmQuest(false)">No</button></div>
  </div>
  
  <div class="modal" id="gateModal">
    <div class="modal-content panel">
        <h3 id="gateModalTitle">New Gate Discovered!</h3>
        <p id="gateModalText"></p>
        <p id="gateModalRewards"></p>
        <button onclick="acceptGateQuest()">Accept</button>
        <button onclick="declineGateQuest()" class="decline">Decline</button>
    </div>
  </div>

  <div id="notification-container"></div>

  <script>
    // --- DATE HELPER FUNCTIONS (BUG FIX) ---
    function todayISO() {
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      return d.toISOString().slice(0, 10);
    }
    function isoToDate(iso) {
      const [y, m, day] = iso.split('-').map(Number);
      return new Date(y, m - 1, day);
    }
    function daysBetweenISO(fromISO, toISO) {
      if (!fromISO || !toISO) return 0;
      const a = isoToDate(fromISO).getTime();
      const b = isoToDate(toISO).getTime();
      return Math.round((b - a) / (1000 * 60 * 60 * 24));
    }

    const ranks = ["F", "E", "D", "C", "B", "A", "S", "S+", "S++"];
    const rankMultiplier = [ 1, 1.05, 1.1, 1.15, 1.2, 1.25, 1.3, 1.35, 1.4 ];
    const rankLevelRequirements = [ 1, 2, 4, 7, 10, 14, 18, 23, 29 ];

    const gateQuestPool = {
        0: [ // F-Rank
            { text: "Do 3 wall push-ups", xp: 50, points: 50, gold: 5 },
            { text: "Walk in place for 2 minutes", xp: 55, points: 50, gold: 5 },
            { text: "Brush your teeth after waking", xp: 60, points: 55, gold: 5 },
            { text: "Drink a full glass of water (within 10 min of waking)", xp: 55, points: 50, gold: 5 },
            { text: "Do 5 slow arm circles", xp: 50, points: 50, gold: 5 },
            { text: "Put on outside clothes (even if not going out)", xp: 60, points: 60, gold: 6 }
        ],
        1: [ // E-Rank
            { text: "Do 5 wall push-ups", xp: 60, points: 60, gold: 6 },
            { text: "Walk in place for 5 minutes", xp: 70, points: 65, gold: 6 },
            { text: "Do 10 jumping jacks", xp: 70, points: 70, gold: 7 },
            { text: "Stretch for 1 minute", xp: 65, points: 65, gold: 6 },
            { text: "2 minutes of deep breathing with eyes closed", xp: 70, points: 70, gold: 7 },
            { text: "Write 1 positive sentence about today", xp: 65, points: 65, gold: 6 }
        ],
        2: [ // D-Rank
            { text: "Do 10 push-ups or knee push-ups", xp: 90, points: 85, gold: 8 },
            { text: "Go outside for 3 minutes", xp: 85, points: 80, gold: 8 },
            { text: "Do 15 squats", xp: 90, points: 85, gold: 8 },
            { text: "Meditate for 5 minutes", xp: 100, points: 90, gold: 9 },
            { text: "Hold a plank for 20 seconds", xp: 90, points: 85, gold: 8 },
            { text: "Journal 1 paragraph about how you're feeling", xp: 95, points: 85, gold: 9 }
        ],
        3: [ // C-Rank
            { text: "Do 25 squats", xp: 130, points: 110, gold: 12 },
            { text: "Plank for 40 seconds", xp: 125, points: 115, gold: 12 },
            { text: "3 rounds: 10 jumping jacks + 5 push-ups", xp: 135, points: 120, gold: 13 },
            { text: "Go outside and walk for 10 minutes", xp: 140, points: 125, gold: 13 },
            { text: "10 minutes deep focus on one task", xp: 130, points: 120, gold: 12 },
            { text: "Take a cold or cool shower", xp: 145, points: 130, gold: 14 }
        ],
        4: [ // B-Rank
            { text: "4 rounds: 10 squats + 5 push-ups + 10 arm swings", xp: 180, points: 150, gold: 16 },
            { text: "20-minute no screen zone", xp: 170, points: 150, gold: 15 },
            { text: "Do one delayed chore for 10+ minutes", xp: 180, points: 160, gold: 16 },
            { text: "Walk for 15 minutes", xp: 175, points: 160, gold: 15 },
            { text: "10 minutes posture/reset stretching", xp: 170, points: 150, gold: 15 },
            { text: "Write one full journal page", xp: 185, points: 165, gold: 17 }
        ],
        5: [ // A-Rank
            { text: "30-minute bodyweight workout", xp: 240, points: 200, gold: 25 },
            { text: "2 hours no screen, just silence/focus", xp: 250, points: 210, gold: 25 },
            { text: "Deep-clean one room/zone", xp: 230, points: 200, gold: 24 },
            { text: "Cook/prepare one healthy item", xp: 220, points: 190, gold: 23 },
            { text: "Message someone something real/kind", xp: 210, points: 180, gold: 22 },
            { text: "Cold exposure for 5 minutes", xp: 260, points: 220, gold: 26 }
        ],
        6: [ // S-Rank
            { text: "30-minute full-body workout with intensity", xp: 300, points: 250, gold: 30 },
            { text: "Write down every lie you’re telling yourself", xp: 320, points: 260, gold: 32 },
            { text: "Create something for 30+ minutes (draw, write, design)", xp: 310, points: 250, gold: 30 },
            { text: "Go fully offline for 3+ hours and reflect", xp: 330, points: 275, gold: 33 },
            { text: "Read a real book for 30 minutes", xp: 300, points: 240, gold: 28 },
            { text: "Sit in silence with yourself for 20 minutes", xp: 310, points: 260, gold: 30 }
        ],
        7: [ // S+-Rank
            { text: "Complete a full 45-minute intense workout (no breaks longer than 1 min)", xp: 400, points: 320, gold: 40 },
            { text: "Sit with your biggest internal fear — journal 2 full pages about it", xp: 420, points: 340, gold: 42 },
            { text: "Do a full room reset: clean, organize, and emotionally reclaim it", xp: 430, points: 350, gold: 43 },
            { text: "Talk openly with someone you’ve been avoiding or hiding from", xp: 410, points: 330, gold: 41 },
            { text: "Fast from all screens and input for 6 hours — just exist", xp: 440, points: 360, gold: 44 },
            { text: "Take one action on a life goal you’ve been delaying for weeks", xp: 450, points: 375, gold: 45 }
        ],
        8: [ // S++-Rank
            { text: "Spend 1 hour in complete silence, no distractions, no stimulation — just you and your thoughts", xp: 500, points: 420, gold: 50 },
            { text: "Write a full letter to your future self — 3+ pages, raw and honest", xp: 520, points: 440, gold: 52 },
            { text: "Commit to a full day of self-discipline (no PMO, no sugar, no excuses, full routine)", xp: 530, points: 450, gold: 53 },
            { text: "Perform a “ritual” reset: shower, groom, dress, clean, breathe, sit — reset your entire being", xp: 510, points: 430, gold: 51 },
            { text: "Forgive yourself — truly — by writing out what you regret and letting it go", xp: 540, points: 470, gold: 54 },
            { text: "Take the first step on a major life decision you’ve been avoiding — no matter how small", xp: 550, points: 480, gold: 55 }
        ]
    };

    const defaultData = {
      level: 1, xp: 0, points: 0, gold: 0, silver: 0, rank: 0,
      activeGates: [],
      gateStats: { accepted: 0, declined: 0 },
      gateLog: [], // NEW
      craftingItems: { 'low_mana_crystal': 0, 'enhancement_gear': 0, 'marks_of_time': 0, 'design': 0 }, // NEW
      dailyQuests: [
        { id: 'brush_teeth_1', text: "Brush teeth (morning)", xp: 10, points: 2, done: false },
        { id: 'brush_teeth_2', text: "Brush teeth (evening)", xp: 10, points: 2, done: false },
        { id: 'take_meds', text: "Take meds (in less than 10 min)", xp: 15, points: 3, done: false },
        { id: 'limit_pmo', text: "Stay under 1.5h PMO total today", xp: 25, points: 10, done: false }, 
        { id: 'sleep_meds', text: "Take sleeping meds before 2:30AM", xp: 25, points: 10, gold: 1, done: false },
        { id: 'fresh_air', text: "Get fresh air (5 min outside or near window)", xp: 10, points: 3, done: false }, 
        { id: 'short_stretch', text: "Stretch or move for 1-2 minutes", xp: 15, points: 5, done: false }, 
        { id: 'short_workout', text: "Short workout (1–3 min, light effort)", xp: 20, points: 5, done: false },
        { id: 'skin_routine', text: "Skin Routine face/leg", xp: 20, points: 5, done: false },
      ],
      dailyPhysicalQuests: [
        { text: "Naked Yoga (5 min)", xp: 30, points: 8, done: false }, { text: "Naked Yoga (10 min)", xp: 50, points: 12, done: false },
        { text: "Naked Workout (5 min)", xp: 30, points: 8, done: false }, { text: "Quick Morning Stretch (2 min, naked optional)", xp: 15, points: 5, done: false },
        { text: "Toe Tap (1 min, lying down, naked optional)", xp: 15, points: 5, done: false }, { text: "Crunch Kicks (1 min, lying down, naked optional)", xp: 20, points: 6, done: false },
        { text: "Handen achter rug klemmen (1 min, naked optional)", xp: 15, points: 5, done: false }, { text: "Omgekeerde Sneeuwengelen (1 min, lying down, naked optional)", xp: 20, points: 6, done: false },
        { text: "Prone Flutter Kicks (1 min, lying down, naked optional)", xp: 20, points: 6, done: false }, { text: "Optillen Gestrekt Been links/rechts (1 min each, naked optional)", xp: 25, points: 7, done: false },
        { text: "Crunches buikspieren (1 min, lying down, naked optional)", xp: 25, points: 7, done: false }, { text: "Leg In and Outs (1 min, sitting or lying, naked optional)", xp: 20, points: 6, done: false },
        { text: "Armen Zijwaarts Optillen (1 min, naked optional)", xp: 15, points: 5, done: false }, { text: "Arm Circles (1 min, naked optional)", xp: 15, points: 5, done: false },
        { text: "Butt Bridge (1 min, lying down, naked optional)", xp: 20, points: 6, done: false }, { text: "Beenslag Achter links/rechts (1 min each, naked optional)", xp: 25, points: 7, done: false },
        { text: "Standing Dumbbell Curl (1 min, naked optional)", xp: 25, points: 7, done: false }, { text: "Crossbody Hammer Curl (1 min, naked optional)", xp: 25, points: 7, done: false },
        { text: "Geconcentreerde Dumbbell Curl links/rechts (1 min each, seated, naked optional)", xp: 30, points: 8, done: false }
      ],
      allSpecialQuests: [
        { text: "Spend one day with less than 30 min total PMO", xp: 200, points: 50 }, { text: "Exercise for 10min", xp: 120, points: 30 },
        { text: "Change bed sheets", xp: 120, points: 30 }, { text: "Organize files", xp: 120, points: 30 },
        { text: "Eye Exercise (once)", xp: 120, points: 35 }, { text: "Clip nails (hands or feet)", xp: 80, points: 20 },
        { text: "Use mouthwash (Listerine)", xp: 100, points: 25 }, { text: "Spend one day completely without PMO", xp: 400, points: 150 },
        { text: "Stretch for 5 min straight", xp: 100, points: 30 }, { text: "Walk (or move around room) continuously for 5 mins", xp: 120, points: 50 },
        { text: "Complete short physical therapy or guided workout video (5-10 min)", xp: 130, points: 60 }, { text: "Vacuum/sweep bedroom", xp: 150, points: 40 },
        { text: "Organize one small physical area (desk, shelf, drawer)", xp: 120, points: 30 }, { text: "Successfully delay PMO impulse by 1 hour (once)", xp: 175, points: 80 },
        { text: "Perform gentle (naked) yoga/stretching for 10 mins", xp: 120, points: 35 }, { text: "One time sleep at (2AM)", xp: 120, points: 30 }
      ],
      activeSpecials: [],
      lastDailyReset: todayISO(),
      lastSpecialReset: todayISO(),
      lastPhysicalReset: todayISO(),
      dailyStreaks: {
        'brush_teeth_daily': { current: 0, lastCompletionDate: null },
        'take_meds_daily': { current: 0, lastCompletionDate: null },
        'sleep_meds_daily': { current: 0, lastCompletionDate: null },
        'limit_pmo_daily': { current: 0, lastCompletionDate: null }
      },
      streakQuests: [
        // Brush Teeth Streaks
        { id: 'brush_7_days', parentQuestId: 'brush_teeth_daily', threshold: 7, text: "Brush teeth 7 days in a row", xp: 500, points: 100, gold: 5, done: false },
        { id: 'brush_14_days', parentQuestId: 'brush_teeth_daily', threshold: 14, text: "Brush teeth 10 days in a row", xp: 1000, points: 200, gold: 10, done: false },
        { id: 'brush_30_days', parentQuestId: 'brush_teeth_daily', threshold: 30, text: "Brush teeth 1 month in a row", xp: 2500, points: 500, gold: 25, done: false },
        // Take Meds Streaks
        { id: 'meds_2_days', parentQuestId: 'take_meds_daily', threshold: 2, text: "Took meds 2 days in a row", xp: 150, points: 30, gold: 2, done: false },
        { id: 'meds_4_days', parentQuestId: 'take_meds_daily', threshold: 4, text: "Took meds 4 days in a row", xp: 300, points: 60, gold: 4, done: false },
        { id: 'meds_7_days', parentQuestId: 'take_meds_daily', threshold: 7, text: "Took meds 1 week in a row", xp: 600, points: 120, gold: 8, done: false },
        { id: 'meds_14_days', parentQuestId: 'take_meds_daily', threshold: 14, text: "Took meds 2 weeks in a row", xp: 1200, points: 240, gold: 15, done: false },
        { id: 'meds_30_days', parentQuestId: 'take_meds_daily', threshold: 30, text: "Took meds 1 month in a row", xp: 3000, points: 600, gold: 30, done: false },
        // Sleeping Meds Streaks
        { id: 'sleep_meds_2_days', parentQuestId: 'sleep_meds_daily', threshold: 2, text: "Take sleeping meds 2 days in a row", xp: 150, points: 30, gold: 2, done: false },
        { id: 'sleep_meds_5_days', parentQuestId: 'sleep_meds_daily', threshold: 5, text: "Take sleeping meds 5 days in a row", xp: 300, points: 70, gold: 5, done: false },
        { id: 'sleep_meds_7_days', parentQuestId: 'sleep_meds_daily', threshold: 7, text: "Take sleeping meds 1 week in a row", xp: 500, points: 80, gold: 7, done: false },
        { id: 'sleep_meds_14_days', parentQuestId: 'sleep_meds_daily', threshold: 14, text: "Take sleeping meds 2 weeks in a row", xp: 800, points: 250, gold: 15, done: false },
        { id: 'sleep_meds_21_days', parentQuestId: 'sleep_meds_daily', threshold: 21, text: "Take sleeping meds 3 weeks in a row", xp: 1250, points: 350, gold: 25, done: false },
        { id: 'sleep_meds_30_days', parentQuestId: 'sleep_meds_daily', threshold: 30, text: "Take sleeping meds 1 month in a row", xp: 2000, points: 500, gold: 50, done: false },
        // PMO Streaks
        { id: 'pmo_2_days', parentQuestId: 'limit_pmo_daily', threshold: 2, text: "Stay under 1.5h PMO 2 days in a row", xp: 200, points: 40, gold: 2, done: false },
        { id: 'pmo_5_days', parentQuestId: 'limit_pmo_daily', threshold: 5, text: "Stay under 1.5h PMO 5 days in a row", xp: 500, points: 100, gold: 5, done: false },
        { id: 'pmo_7_days', parentQuestId: 'limit_pmo_daily', threshold: 7, text: "Stay under 1.5h PMO 1 week in a row", xp: 900, points: 180, gold: 10, done: false },
        { id: 'pmo_14_days', parentQuestId: 'limit_pmo_daily', threshold: 14, text: "Stay under 1.5h PMO 2 weeks in a row", xp: 1600, points: 350, gold: 20, done: false },
        { id: 'pmo_21_days', parentQuestId: 'limit_pmo_daily', threshold: 21, text: "Stay under 1.5h PMO 3 weeks in a row", xp: 2400, points: 500, gold: 35, done: false },
        { id: 'pmo_30_days', parentQuestId: 'limit_pmo_daily', threshold: 30, text: "Stay under 1.5h PMO 1 month in a row", xp: 3500, points: 800, gold: 60, done: false }
      ],
      shopWeapons: [
        { id: 'orcs_broadsword', name: "Orc's Broadsword", cost: 30, currency: "silver", requiredRank: 0, icon: 'GSWeapon_OrcGreatSword.png', ability: "Heavy and rusty. Better than bare hands." },
        { id: 'lizard_glaive', name: "Lizard Glaive", cost: 35, currency: "silver", requiredRank: 0, icon: 'GSWeapon_LizardGlaive.png', ability: "Crooked shaft, dull tip. Still reaches." },
        { id: 'grave_keepers_scythe', name: "Grave Keeper's Scythe", cost: 40, currency: "silver", requiredRank: 0, icon: 'GSWeapon_GravekeeperScythe.png', ability: "Old and chipped. A gravekeeper still used it." },
        { id: 'ice_elfs_bow', name: "Ice Elf's Bow", cost: 60, currency: "silver", requiredRank: 1, icon: 'GSWeapon_IceElfBow.png', ability: "Wild tension, poor accuracy—but it shoots." },
        { id: 'rock_golem_hammer', name: "Rock Golem Hammer", cost: 65, currency: "silver", requiredRank: 1, icon: 'GSWeapon_StoneGolemHammer.png', ability: "Heavy club made from cracked stone." },
        { id: 'sandstorm_cube', name: "Sandstorm Cube", cost: 70, currency: "silver", requiredRank: 1, icon: 'GSWeapon_SandCentipedeCube.png', ability: "Weird artifact that rattles when you swing." },
        { id: 'arachnids_hand_crossbow', name: "Arachnid's Hand Crossbow", cost: 90, currency: "silver", requiredRank: 2, icon: 'GSWeapon_GiantArachne_01.png', ability: "Light crossbow—shoots fast, not far." },
        { id: 'frostbite_falchion', name: "Frostbite Falchion", cost: 95, currency: "silver", requiredRank: 2, icon: 'GSWeapon_FrostIceSword.png', ability: "Cold blade that chills the air." },
        { id: 'dragonscale_broadsword', name: "Dragonscale Broadsword", cost: 100, currency: "silver", requiredRank: 2, icon: 'GSWeapon_DragnScaleGreatBlade.png', ability: "Scaled edge with minor sparkle." },
        { id: 'lustrous_dragon_sword', name: "Lustrous Dragon Sword", cost: 150, currency: "silver", requiredRank: 3, icon: 'GSWeapon_Lustrous_Dragon_Sword.png', ability: "A bright steel edge said to inspire awe." },
        { id: 'knights_sword', name: "Knight's Sword", cost: 160, currency: "silver", requiredRank: 3, icon: 'GSWeapon_KnightSword.png', ability: "Reliable blade for fledgling fighters." },
        { id: 'west_wind', name: "West Wind", cost: 180, currency: "gold", requiredRank: 4, icon: 'GSWeapon_Westwind.png', ability: "Swift as the wind—light and nimble." },
        { id: 'kim_sangshiks_sword', name: "Kim Sangshik's Sword", cost: 185, currency: "gold", requiredRank: 4, icon: 'GSWeapon_KimSangShik_01.png', ability: "Blade with a subtle personal touch." },
        { id: 'juicy_grilled_skewer', name: "Juicy Grilled Skewer", cost: 220, currency: "gold", requiredRank: 5, icon: 'skewer.png', ability: "Oddly satisfying to swing." },
        { id: 'radiru_family_longbow', name: "Radiru Family's Longbow", cost: 230, currency: "gold", requiredRank: 5, icon: 'GSWeapon_RadiruGreatBow_01.png', ability: "Crafted for long-range precision." },
        { id: 'orb_of_avarice', name: "Orb of Avarice", cost: 240, currency: "gold", requiredRank: 5, icon: 'GSWeapon_OrbofAvarice.png', ability: "Heavy orb that hums greedily." },
        { id: 'demon_kings_longsword', name: "Demon King’s Longsword", cost: 300, currency: "gold", requiredRank: 6, icon: 'GSWeapon_DemonKingLongSword_01.png', ability: "Heavy blade forged in ancient dark fires." },
        { id: 'zekes_fragment', name: "Zeke's Fragment", cost: 310, currency: "gold", requiredRank: 6, icon: 'zeke.png', ability: "Shattered gem glowing with latent power." },
        { id: 'winter_fang', name: "Winter Fang", cost: 350, currency: "gold", requiredRank: 7, icon: 'weapon_winter.png', ability: "Icy edge that freezes the breath around it." },
        { id: 'stormbringer', name: "Stormbringer", cost: 360, currency: "gold", requiredRank: 7, icon: 'weapon_stormbringer.png', ability: "Crackling blade that channels storms." },
        { id: 'phoenix_soul', name: "Phoenix Soul", cost: 400, currency: "gold", requiredRank: 8, icon: 'phe_icon.png', ability: "Blazing aura in a slender form—a living fire." },
        { id: 'thethis_grimoire', name: "Thethis' Grimoire", cost: 410, currency: "gold", requiredRank: 8, icon: 'GSWeapon_Tethis_01.png', ability: "Ancient tome of unknown incantations." },
        { id: 'moonshadow', name: "Moonshadow", cost: 420, currency: "gold", requiredRank: 8, icon: 'GSWeapon_MoonShadow.png', ability: "Stealth blade wreathed in lunar mist." },
        { id: 'demonic_plum_flower_sword', name: "Demonic Plum Flower Sword", cost: 430, currency: "gold", requiredRank: 8, icon: 'GSWeapon_Demonic_Plum_Flower_Sword.png', ability: "Elegant and deadly, petal-blade forged in hell." },
        { id: 'demon_kings_daggers', name: "Demon King's Daggers", cost: 440, currency: "gold", requiredRank: 8, icon: 'GSWeapon_DemonKingsDaggers.png', ability: "Twin daggers that thirst for blood." },
        { id: 'truth_kasakas_venom_fang', name: "Truth: Kasaka's Venom Fang", cost: 490, currency: "gold", requiredRank: 8, icon: 'weapon_truth.png', ability: "Venom-laced blade that whispers death." },
        { id: 'vulcans_rage', name: "Vulcan's Rage", cost: 500, currency: "gold", requiredRank: 8, icon: 'GSWeapon_Vulcan.png', ability: "Inferno-forged weapon that burns through the soul." },
        { id: 'skadi', name: "Skadi", cost: 530, currency: "gold", requiredRank: 8, icon: 'skadi_weapon.png', ability: "Chilling spear of frost and fate." },
        { id: 'the_huntsman', name: "The Huntsman", cost: 540, currency: "gold", requiredRank: 8, icon: 'GSWeapon_TheHuntsman.png', ability: "A hunter’s edge: silent, sharp, merciless." }
      ],
      shopItems: [
        { id: 'diamond_item', name: "Diamond", cost: 100, currency: "points", rewardType: "gold", rewardAmount: 1, icon: 'Diament.png', ability: "Converts 100 Points into 1 Gold." },
        { id: 'mana_crystal', name: "Mana Crystal", cost: 10, currency: "points", rewardType: "silver", rewardAmount: 50, icon: 'ManaCrystal.png', ability: "Converts 10 Points into 50 Silver." },
        { id: 'advanced_mana_crystal', name: "Advanced Mana Crystal", cost: 1000, currency: "silver", rewardType: "xp", rewardAmount: 250, icon: 'AdvancedManaCrystal.png', ability: "Converts 1000 Silver into 250 XP." }
      ],
      ownedWeapons: [], 
      weaponCollectionCompleted: false 
    };

    let data = { ...defaultData };
    let currentQuestType = null;
    let currentQuestIndex = null;
    let tempGateQuest = null;

    function updateUI() {
      document.getElementById("level").textContent = data.level;
      document.getElementById("points").textContent = data.points;
      document.getElementById("gold").textContent = data.gold;
      document.getElementById("silver").textContent = data.silver;
      document.getElementById("rank").textContent = ranks[data.rank];
      document.getElementById("shopPoints").textContent = data.points;
      document.getElementById("shopGold").textContent = data.gold;
      document.getElementById("shopSilver").textContent = data.silver;

      let xpNeeded = data.level * 200;
      let percent = data.xp > 0 ? Math.min((data.xp / xpNeeded) * 100, 100) : 0;
      let fill = document.getElementById("xpFill");
      fill.style.width = percent + "%";
      fill.textContent = `${data.xp} / ${xpNeeded} XP`;

      const dList = document.getElementById("dailyList");
      dList.innerHTML = "";
      data.dailyQuests.forEach((q, i) => {
        const li = document.createElement("li");
        let rewardText = `+${q.xp} XP / +${q.points}P`;
        if (q.gold) {
            rewardText += ` / +${q.gold} Gold`;
        }
        li.textContent = `${q.text} (${rewardText})`;
        if (q.done) { li.classList.add('done'); } else { li.onclick = () => openModal("daily", i); }
        dList.appendChild(li);
      });

      const dpList = document.getElementById("dailyPhysicalList");
      dpList.innerHTML = "";
      data.dailyPhysicalQuests.forEach((q, i) => {
        const li = document.createElement("li");
        li.textContent = `${q.text} (+${q.xp} XP / +${q.points}P)`;
        if (q.done) { li.classList.add('done'); } else { li.onclick = () => openModal("dailyPhysical", i); }
        dpList.appendChild(li);
      });

      const sList = document.getElementById("specialList");
      sList.innerHTML = "";
      data.activeSpecials.forEach((q, i) => {
        const li = document.createElement("li");
        let daysLeftText = q.daysLeft > 0 ? ` – ${q.daysLeft} day${q.daysLeft !== 1 ? 's' : ''} left` : ' – Expired';
        li.textContent = `${q.text} (+${q.xp} XP / +${q.points}P)`;
        const spanDaysLeft = document.createElement('span');
        spanDaysLeft.textContent = daysLeftText;
        li.appendChild(spanDaysLeft);
        if (q.done || q.daysLeft <= 0) { li.classList.add('done'); } else { li.onclick = () => openModal("special", i); }
        sList.appendChild(li);
      });

      const streakList = document.getElementById("streakList");
      streakList.innerHTML = "";
      data.streakQuests.forEach((q) => {
          const li = document.createElement("li");
          li.textContent = `${q.text} (+${q.xp} XP / +${q.points}P / +${q.gold} Gold)`;
          if (q.done) {
              li.classList.add('done');
          } else {
              const parentStreak = data.dailyStreaks[q.parentQuestId];
              if (parentStreak) {
                  li.textContent += ` (Current streak: ${parentStreak.current}/${q.threshold} days)`;
              }
              li.style.cursor = 'default';
          }
          streakList.appendChild(li);
      });

      updateRankUpgradeList();
      updateItemShopList();
      updateWeaponShopList();
      updateInventoryList();
      updateRankUpgradeInfoTable();
      updateGatePage();
      updateTradingPost();
    }

    function openModal(type, index) {
      currentQuestType = type;
      currentQuestIndex = index;
      let q;
      if (type === "daily") { q = data.dailyQuests[index]; } 
      else if (type === "dailyPhysical") { q = data.dailyPhysicalQuests[index]; } 
      else if (type === "special") { q = data.activeSpecials[index]; } 
      else { return; }

      if (q.done || (type === "special" && q.daysLeft <= 0)) { return; }
      document.getElementById("modalText").textContent = `Did you complete: ${q.text}?`;
      document.getElementById("questModal").classList.add('active'); 
    }

    function confirmQuest(yes) {
      document.getElementById("questModal").classList.remove('active'); 
      if (yes) {
        let list;
        if (currentQuestType === "daily") { list = data.dailyQuests; } 
        else if (currentQuestType === "dailyPhysical") { list = data.dailyPhysicalQuests; } 
        else if (currentQuestType === "special") { list = data.activeSpecials; } 
        else { return; }

        const q = list[currentQuestIndex];
        if (!q.done && !(currentQuestType === "special" && q.daysLeft <= 0)) {
          q.done = true;
          const xpGained = Math.floor(q.xp * rankMultiplier[data.rank]);
          const pointsGained = Math.floor(q.points * rankMultiplier[data.rank]);
          const goldGained = q.gold ? Math.floor(q.gold * rankMultiplier[data.rank]) : 0;
          
          data.xp += xpGained;
          data.points += pointsGained;
          if(goldGained > 0) data.gold += goldGained;
          
          let rewardString = `+${xpGained} XP & +${pointsGained} Points`;
          if(goldGained > 0) rewardString += ` & +${goldGained} Gold`;
          showNotification(`Quest Completed! ${rewardString}`, 'quest');

          checkLevelUp();
          if (currentQuestType === "daily") { checkStreaks(q.id); }
          updateUI();
        }
      }
    }

    function checkLevelUp() {
      let needed = data.level * 200;
      while (data.xp >= needed) {
        data.xp -= needed;
        data.level++;
        needed = data.level * 200;
        showNotification(`LEVEL UP! You are now Level ${data.level}`, 'level-up');
      }
    }

    function showPage(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'shop') { showShopPage('mainShop'); }
      if (id === 'generalInfo') { updateRankUpgradeInfoTable(); }
      if (id === 'inventory') { updateInventoryList(); }
    }

    function showShopPage(id) {
        document.querySelectorAll('.shop-menu, .shop-submenu').forEach(sec => sec.classList.remove('active'));
        if (id === 'mainShop') {
            document.querySelector('.shop-menu').classList.add('active');
        } else {
            document.getElementById(id).classList.add('active');
        }
    }

    function updateGatePage() {
        const container = document.getElementById('gate-selection-container');
        container.innerHTML = '<h3>Enter a Gate</h3>';
        for(let i = 0; i < ranks.length; i++) {
            const button = document.createElement('button');
            button.textContent = `Enter Gate (${ranks[i]})`;
            button.disabled = data.rank < i;
            button.onclick = () => enterGate(i);
            container.appendChild(button);
        }

        const list = document.getElementById('active-gates-list');
        list.innerHTML = '';
        if (data.activeGates.length === 0) {
            list.innerHTML = '<li style="cursor:default; opacity: 0.6;">No active gates. Enter one to begin!</li>';
        } else {
            data.activeGates.forEach(gate => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${gate.text}</span>
                    <span class="gate-timer" id="timer-${gate.id}">Time Left: ...</span>
                    <button onclick="completeGate('${gate.id}')">Complete</button>
                `;
                list.appendChild(li);
            });
        }

        document.getElementById('gates-accepted').textContent = data.gateStats.accepted;
        document.getElementById('gates-declined').textContent = data.gateStats.declined;
        updateCodex();
    }

    function enterGate(rankIndex) {
        const pool = gateQuestPool[rankIndex];
        if (!pool || pool.length === 0) {
            showNotification('No quests available for this rank.', 'quest');
            return;
        }
        tempGateQuest = { ...pool[Math.floor(Math.random() * pool.length)], rank: ranks[rankIndex] };
        
        document.getElementById('gateModalText').textContent = tempGateQuest.text;
        document.getElementById('gateModalRewards').textContent = `Rewards: ${tempGateQuest.xp} XP, ${tempGateQuest.points} Points, ${tempGateQuest.gold} Gold`;
        document.getElementById('gateModal').classList.add('active');
    }

    function acceptGateQuest() {
        if (!tempGateQuest) return;
        const newGate = {
            ...tempGateQuest,
            id: `gate-${Date.now()}`,
            expiresAt: Date.now() + 24 * 60 * 60 * 1000
        };
        data.activeGates.push(newGate);
        data.gateStats.accepted++;
        
        document.getElementById('gateModal').classList.remove('active');
        tempGateQuest = null;
        updateUI();
        showNotification('Gate quest accepted! You have 24 hours.', 'quest');
    }

    function declineGateQuest() {
        if (!tempGateQuest) return;
        data.gateStats.declined++;
        addGateToCodex(tempGateQuest, 'Declined');
        document.getElementById('gateModal').classList.remove('active');
        tempGateQuest = null;
        updateUI();
    }

    function completeGate(gateId) {
        const gateIndex = data.activeGates.findIndex(g => g.id === gateId);
        if (gateIndex === -1) return;

        const gate = data.activeGates[gateIndex];
        data.xp += gate.xp;
        data.points += gate.points;
        data.gold += gate.gold;

        showNotification(`Gate Cleared! +${gate.xp} XP, +${gate.points} Points, +${gate.gold} Gold`, 'level-up');
        addGateToCodex(gate, 'Cleared');
        generateGateDrops(data.rank);
        
        data.activeGates.splice(gateIndex, 1);
        checkLevelUp();
        updateUI();
    }

    function updateGateTimers() {
        const now = Date.now();
        let changed = false;
        data.activeGates = data.activeGates.filter(gate => {
            if (gate.expiresAt < now) {
                showNotification(`Gate quest "${gate.text}" expired.`, 'quest');
                addGateToCodex(gate, 'Failed');
                changed = true;
                return false;
            }
            return true;
        });

        data.activeGates.forEach(gate => {
            const timerElement = document.getElementById(`timer-${gate.id}`);
            if (timerElement) {
                const timeLeft = gate.expiresAt - now;
                const hours = Math.floor((timeLeft / (1000 * 60 * 60)) % 24);
                const minutes = Math.floor((timeLeft / 1000 / 60) % 60);
                const seconds = Math.floor((timeLeft / 1000) % 60);
                timerElement.textContent = `Time Left: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        });

        if (changed) {
            updateUI();
        }
    }

    function addGateToCodex(gate, result) {
        const logEntry = {
            date: todayISO(),
            rank: gate.rank,
            text: gate.text,
            result: result,
            rewards: result === 'Cleared' ? { xp: gate.xp, points: gate.points, gold: gate.gold } : null
        };
        data.gateLog.unshift(logEntry); // Add to the beginning of the array
    }

    function updateCodex() {
        const list = document.getElementById('gate-log-list');
        list.innerHTML = '';
        if (data.gateLog.length === 0) {
            list.innerHTML = '<li style="cursor:default; opacity: 0.6;">Your gate history will appear here.</li>';
            return;
        }
        data.gateLog.forEach(entry => {
            const li = document.createElement('li');
            let rewardsText = '';
            if (entry.result === 'Cleared' && entry.rewards) {
                rewardsText = ` | Rewards: ${entry.rewards.xp} XP, ${entry.rewards.points} P, ${entry.rewards.gold} G`;
            }
            li.innerHTML = `
                <div class="log-header">
                    <span>${entry.date} - ${entry.rank}-Rank Gate</span>
                    <span class="log-result-${entry.result.toLowerCase()}">${entry.result}</span>
                </div>
                <div class="log-body">
                    ${entry.text}${rewardsText}
                </div>
            `;
            list.appendChild(li);
        });
    }

    function generateGateDrops(rankIndex) {
        // Define drop pools and weights
        const dropPools = {
            common: ['low_mana_crystal', 'design'],
            uncommon: ['enhancement_gear'],
            rare: ['marks_of_time']
        };
        const weights = {
            // Rank: [common%, uncommon%, rare%]
            0: [80, 19, 1], // F
            1: [75, 23, 2], // E
            2: [70, 25, 5], // D
            3: [65, 28, 7], // C
            4: [60, 30, 10], // B
            5: [55, 33, 12], // A
            6: [50, 35, 15], // S
            7: [45, 35, 20], // S+
            8: [40, 35, 25]  // S++
        };

        const currentWeights = weights[rankIndex] || weights[0];
        
        // Determine number of drops
        let numDrops = 1 + Math.floor(Math.random() * (rankIndex / 2 + 1)); // More drops at higher ranks
        if (Math.random() < 0.05) numDrops = 5; // 5% chance for a jackpot of 5 items
        numDrops = Math.min(numDrops, 5); // Cap at 5

        const drops = {};
        for (let i = 0; i < numDrops; i++) {
            const rand = Math.random() * 100;
            let item;
            if (rand < currentWeights[0]) {
                item = dropPools.common[Math.floor(Math.random() * dropPools.common.length)];
            } else if (rand < currentWeights[0] + currentWeights[1]) {
                item = dropPools.uncommon[Math.floor(Math.random() * dropPools.uncommon.length)];
            } else {
                item = dropPools.rare[Math.floor(Math.random() * dropPools.rare.length)];
            }
            
            data.craftingItems[item]++;
            drops[item] = (drops[item] || 0) + 1;
        }

        let notificationText = "Gate Drops: ";
        notificationText += Object.keys(drops).map(key => `${drops[key]}x ${key.replace(/_/g, ' ')}`).join(', ');
        showNotification(notificationText, 'quest');
    }

    function updateTradingPost() {
        const container = document.getElementById('trading-post-container');
        container.innerHTML = '';

        const tradeOptions = [
            { id: 'low_mana_crystal', name: 'Low-tier Mana Crystal', icon: 'ManaCrystal.png', needed: 3, reward: '+150 Silver' },
            { id: 'enhancement_gear', name: 'Weapon Enhancement Gear I', icon: 'WeaponEnhandcementGear.png', needed: 2, reward: '+25 XP' },
            { id: 'marks_of_time', name: 'Marks of Time', icon: 'MarksOfTime.png', needed: 3, reward: '+1 Gold' },
            { id: 'design', name: 'Design', icon: 'Design.png', needed: 5, reward: '+300 Silver' }
        ];

        tradeOptions.forEach(opt => {
            const card = document.createElement('div');
            card.className = 'trade-card';
            card.innerHTML = `
                <img src="${opt.icon}" alt="${opt.name}">
                <h4>${opt.name}</h4>
                <div class="owned-amount">You have: ${data.craftingItems[opt.id]}</div>
                <div class="trade-info">Sell ${opt.needed} for ${opt.reward}</div>
                <input type="number" id="trade-input-${opt.id}" placeholder="Amount">
                <button id="trade-btn-${opt.id}" onclick="sellItems('${opt.id}', ${opt.needed})">Sell</button>
            `;
            container.appendChild(card);
        });
    }

    function sellItems(itemId, needed) {
        const input = document.getElementById(`trade-input-${itemId}`);
        const amount = parseInt(input.value, 10);

        if (isNaN(amount) || amount <= 0) {
            showNotification("Please enter a valid amount.", 'quest');
            return;
        }
        if (amount > data.craftingItems[itemId]) {
            showNotification("You don't have enough items.", 'quest');
            return;
        }
        if (amount % needed !== 0) {
            showNotification(`Amount must be a multiple of ${needed}.`, 'quest');
            return;
        }

        data.craftingItems[itemId] -= amount;
        const transactions = amount / needed;

        let rewardText = "";
        switch (itemId) {
            case 'low_mana_crystal': data.silver += 150 * transactions; rewardText = `+${150 * transactions} Silver`; break;
            case 'enhancement_gear': data.xp += 25 * transactions; rewardText = `+${25 * transactions} XP`; break;
            case 'marks_of_time': data.gold += 1 * transactions; rewardText = `+${1 * transactions} Gold`; break;
            case 'design': data.silver += 300 * transactions; rewardText = `+${300 * transactions} Silver`; break;
        }
        
        showNotification(`Trade successful! ${rewardText}`, 'level-up');
        input.value = '';
        checkLevelUp();
        updateUI();
    }

    function getRankUpgradeCost(targetRankIndex) {
      const baseCost = 1000;
      return baseCost + (targetRankIndex * 1500);
    }

    function updateRankUpgradeList() {
      const rankList = document.getElementById("rankUpgradeList");
      rankList.innerHTML = "";
      for (let i = 0; i < ranks.length - 1; i++) {
        const nextRankIndex = i + 1;
        const upgradeLevelRequired = rankLevelRequirements[nextRankIndex];
        const upgradePointsCost = getRankUpgradeCost(nextRankIndex);
        const li = document.createElement("li");
        li.innerHTML = `<span>Upgrade from <strong>${ranks[i]}</strong> to <strong>${ranks[nextRankIndex]}</strong>:</span><br><span>Requires: Level ${upgradeLevelRequired}, ${upgradePointsCost} Points</span>`;
        const buyButton = document.createElement("button");
        buyButton.textContent = "Buy";
        buyButton.onclick = () => buyRankUpgrade(i);
        if (data.rank === i) {
          buyButton.disabled = !(data.level >= upgradeLevelRequired && data.points >= upgradePointsCost);
        } else if (data.rank > i) {
          buyButton.textContent = "Achieved";
          buyButton.disabled = true;
          li.classList.add('done');
        } else {
          buyButton.textContent = "Locked";
          buyButton.disabled = true;
        }
        li.appendChild(buyButton);
        rankList.appendChild(li);
      }
    }

    function buyRankUpgrade(rankIndex) {
      const nextRankIndex = rankIndex + 1;
      const requiredLevel = rankLevelRequirements[nextRankIndex];
      const cost = getRankUpgradeCost(nextRankIndex);

      if (data.level >= requiredLevel && data.points >= cost && data.rank === rankIndex) {
        data.points -= cost;
        data.rank = nextRankIndex;
        showNotification(`RANK UP! You are now Rank ${ranks[data.rank]}!`, 'level-up');
        updateUI();
      } else {
        alert("You do not meet the requirements for this rank upgrade.");
      }
    }

    function updateItemShopList() {
      const itemList = document.getElementById("itemList");
      itemList.innerHTML = "";
      defaultData.shopItems.forEach(item => {
        const li = document.createElement("li");
        li.classList.add('item-card');
        li.innerHTML = `<img src="${item.icon}" alt="${item.name} icon" class="item-icon"><span class="item-card-name">${item.name}</span><span class="item-card-cost-display">Cost: ${item.cost} ${item.currency}</span><span class="item-card-effect">${item.ability}</span>`;
        const buyButton = document.createElement("button");
        buyButton.textContent = "Buy";
        let hasEnoughCurrency = (item.currency === "points" && data.points >= item.cost) || (item.currency === "silver" && data.silver >= item.cost) || (item.currency === "gold" && data.gold >= item.cost);
        buyButton.disabled = !hasEnoughCurrency;
        buyButton.onclick = () => buyItem(item.id);
        li.appendChild(buyButton);
        itemList.appendChild(li);
      });
    }

    function buyItem(itemId) {
      const item = defaultData.shopItems.find(i => i.id === itemId);
      if (!item) { return; }
      let hasEnoughCurrency = (item.currency === "points" && data.points >= item.cost) || (item.currency === "silver" && data.silver >= item.cost) || (item.currency === "gold" && data.gold >= item.cost);
      if (!hasEnoughCurrency) { showNotification(`Not enough ${item.currency}!`, 'quest'); return; }
      
      if (item.currency === "points") { data.points -= item.cost; } else if (item.currency === "silver") { data.silver -= item.cost; } else if (item.currency === "gold") { data.gold -= item.cost; }

      let rewardText = "";
      if (item.rewardType === "xp") { data.xp += item.rewardAmount; checkLevelUp(); rewardText = `${item.rewardAmount} XP`; }
      else if (item.rewardType === "points") { data.points += item.rewardAmount; rewardText = `${item.rewardAmount} Points`; }
      else if (item.rewardType === "gold") { data.gold += item.rewardAmount; rewardText = `${item.rewardAmount} Gold`; }
      else if (item.rewardType === "silver") { data.silver += item.rewardAmount; rewardText = `${item.rewardAmount} Silver`; }
      showNotification(`Item Purchased: +${rewardText}`, 'quest');
      updateUI();
    }

    function updateWeaponShopList() {
      const weaponList = document.getElementById("weaponList");
      weaponList.innerHTML = "";
      defaultData.shopWeapons.forEach(weapon => {
        const li = document.createElement("li");
        li.classList.add('weapon-card');
        const alreadyOwned = data.ownedWeapons.includes(weapon.id);
        li.innerHTML = `<img src="${weapon.icon}" alt="${weapon.name} icon" class="weapon-item-icon"><span class="weapon-card-name">${weapon.name}</span><span class="weapon-card-rank">Rank: ${ranks[weapon.requiredRank]}</span><span class="weapon-card-cost">Cost: ${weapon.cost} ${weapon.currency}</span><span class="weapon-card-ability">${weapon.ability}</span>`;
        const buyButton = document.createElement("button");
        if (alreadyOwned) {
          buyButton.textContent = "Owned"; buyButton.disabled = true; li.classList.add('done');
        } else {
          buyButton.textContent = "Buy";
          const hasEnoughCurrency = (weapon.currency === "silver" && data.silver >= weapon.cost) || (weapon.currency === "gold" && data.gold >= weapon.cost);
          const hasRequiredRank = data.rank >= weapon.requiredRank;
          buyButton.disabled = !hasEnoughCurrency || !hasRequiredRank;
          buyButton.onclick = () => buyWeapon(weapon.id);
        }
        li.appendChild(buyButton);
        weaponList.appendChild(li);
      });
    }

    function buyWeapon(weaponId) {
      const weapon = defaultData.shopWeapons.find(w => w.id === weaponId);
      if (!weapon || data.ownedWeapons.includes(weaponId)) { return; }
      const hasEnoughCurrency = (weapon.currency === "silver" && data.silver >= weapon.cost) || (weapon.currency === "gold" && data.gold >= weapon.cost);
      const hasRequiredRank = data.rank >= weapon.requiredRank;
      if (!hasRequiredRank) { showNotification(`Rank ${ranks[weapon.requiredRank]} required.`, 'quest'); return; }
      if (!hasEnoughCurrency) { showNotification(`Not enough ${weapon.currency}!`, 'quest'); return; }

      if (weapon.currency === "silver") { data.silver -= weapon.cost; } else { data.gold -= weapon.cost; }
      data.ownedWeapons.push(weapon.id);

      if (!data.weaponCollectionCompleted && data.ownedWeapons.length === defaultData.shopWeapons.length) {
        data.weaponCollectionCompleted = true;
        data.xp += 2000; data.points += 500; data.gold += 100; data.silver += 2000;
        showNotification(`ALL WEAPONS COLLECTED! Grand bonus!`, 'level-up');
      } else {
        showNotification(`Weapon Acquired: ${weapon.name}!`, 'quest');
      }
      checkLevelUp();
      updateUI();
    }

    function updateInventoryList() {
      const inventoryList = document.getElementById("inventoryList");
      inventoryList.innerHTML = "";
      if (data.ownedWeapons.length === 0) {
        inventoryList.innerHTML = "<li class='panel' style='cursor:default; opacity: 0.6;'>No weapons in your inventory yet. Visit the Weapon Shop!</li>";
        return;
      }
      data.ownedWeapons.forEach(weaponId => {
        const weapon = defaultData.shopWeapons.find(w => w.id === weaponId);
        if (weapon) {
          const li = document.createElement("li");
          li.classList.add('weapon-card');
          li.innerHTML = `<img src="${weapon.icon}" alt="${weapon.name} icon" class="weapon-item-icon"><span class="weapon-card-name">${weapon.name}</span><span class="weapon-card-rank">Rank: ${ranks[weapon.requiredRank]}</span><span class="weapon-card-ability">${weapon.ability}</span>`;
          inventoryList.appendChild(li);
        }
      });
    }

    function checkStreaks(completedDailyQuestId) {
        const today = todayISO();
        
        const questToStreakMap = {
            'brush_teeth_1': 'brush_teeth_daily',
            'brush_teeth_2': 'brush_teeth_daily',
            'take_meds': 'take_meds_daily',
            'sleep_meds': 'sleep_meds_daily',
            'limit_pmo': 'limit_pmo_daily'
        };

        const streakKey = questToStreakMap[completedDailyQuestId];

        if (streakKey) {
            const streak = data.dailyStreaks[streakKey];
            if (streak.lastCompletionDate !== today) {
                updateSingleStreak(streakKey, today);
            }
        }

        data.streakQuests.forEach(streakQuest => {
            if (!streakQuest.done && data.dailyStreaks[streakQuest.parentQuestId] && data.dailyStreaks[streakQuest.parentQuestId].current >= streakQuest.threshold) {
                streakQuest.done = true;
                data.xp += streakQuest.xp;
                data.points += streakQuest.points;
                data.gold += streakQuest.gold;
                checkLevelUp();
                showNotification(`Streak Completed: ${streakQuest.text}!`, 'streak');
            }
        });
    }

    function updateSingleStreak(streakKey, todayISO) {
      let streak = data.dailyStreaks[streakKey];
      if (!streak) { streak = { current: 0, lastCompletionDate: null }; data.dailyStreaks[streakKey] = streak; }
      
      const lastDateISO = streak.lastCompletionDate;
      if (lastDateISO === todayISO) { return; }

      if (lastDateISO && daysBetweenISO(lastDateISO, todayISO) === 1) {
        streak.current++;
      } else {
        streak.current = 1;
      }
      streak.lastCompletionDate = todayISO;
    }

    function saveProgress() {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'solo-leveling-progress.json';
      a.click();
      URL.revokeObjectURL(a.href);
      showNotification('Progress Saved!', 'quest');
    }

    function loadProgress(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const loadedData = JSON.parse(ev.target.result);
          let freshData = JSON.parse(JSON.stringify(defaultData));
          data = { ...freshData, ...loadedData };
          data.gateStats = { ...freshData.gateStats, ...loadedData.gateStats };
          data.dailyStreaks = { ...freshData.dailyStreaks, ...loadedData.dailyStreaks };
          data.activeGates = loadedData.activeGates || [];
          data.gateLog = loadedData.gateLog || [];
          data.craftingItems = { ...freshData.craftingItems, ...loadedData.craftingItems };

          showNotification('Progress Loaded Successfully!', 'quest');
          performDailyAndSpecialResets(); 
          updateUI(); 
        } catch (error) {
          alert("Error loading progress: Invalid file or data format.");
          console.error("Loading error:", error);
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    function updateRankUpgradeInfoTable() {
        const tableBody = document.getElementById("rankUpgradeInfoTableBody");
        if (!tableBody) return; 
        tableBody.innerHTML = "";
        for (let i = 0; i < ranks.length - 1; i++) {
            const row = tableBody.insertRow();
            row.insertCell().textContent = ranks[i];
            row.insertCell().textContent = ranks[i + 1];
            row.insertCell().textContent = `Level ${rankLevelRequirements[i + 1]}`;
            row.insertCell().textContent = `${getRankUpgradeCost(i + 1)} Points`;
        }
    }

    function checkDailyReset() {
      const today = todayISO();
      if (data.lastDailyReset !== today) {
        data.dailyQuests.forEach(q => q.done = false);
        data.lastDailyReset = today;
      }
      if (data.lastPhysicalReset !== today) {
        data.dailyPhysicalQuests.forEach(q => q.done = false);
        data.lastPhysicalReset = today;
      }
      for (const key in data.dailyStreaks) {
          const streak = data.dailyStreaks[key];
          if (streak.lastCompletionDate) {
              if (daysBetweenISO(streak.lastCompletionDate, today) > 1) {
                  streak.current = 0;
              }
          }
      }
    }

    function resetSpecials() {
      const today = todayISO();
      const last = data.lastSpecialReset || today;
      const diffDays = daysBetweenISO(last, today);

      if (data.activeSpecials.length === 0 || diffDays >= 3) {
        data.activeSpecials = [];
        const availableQuests = [...data.allSpecialQuests];
        for (let i = availableQuests.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [availableQuests[i], availableQuests[j]] = [availableQuests[j], availableQuests[i]];
        }
        for (let i = 0; i < 5 && availableQuests.length > 0; i++) {
          data.activeSpecials.push({ ...availableQuests.shift(), daysLeft: 3, done: false });
        }
        data.lastSpecialReset = today;
        return;
      }

      if (diffDays > 0) {
        data.activeSpecials.forEach(q => {
          if (!q.done && q.daysLeft > 0) q.daysLeft = Math.max(0, q.daysLeft - diffDays);
        });
        data.activeSpecials = data.activeSpecials.filter(q => q.daysLeft > 0 || q.done);
        data.lastSpecialReset = today;
      }
    }

    function performDailyAndSpecialResets() {
      checkDailyReset();
      resetSpecials();
      updateGateTimers();
    }

    function showNotification(message, type = 'quest') {
      const container = document.getElementById('notification-container');
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      notif.textContent = message;
      container.appendChild(notif);
      setTimeout(() => { notif.remove(); }, 5000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        performDailyAndSpecialResets();
        updateUI(); 
        showPage('status'); 
        setInterval(updateGateTimers, 1000);
    });
  </script>
</body>
</html>
