
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Progress Tracker</title>
  <style>
    :root {
      --bg: #0a0a0f;
      --panel: #1e1e2e;
      --accent: #ffcc00;
      --highlight: #00d1ff;
      --text: #f0f0f0;
      --xp-fill: #00ffcc;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .nav, .xp-bar-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 10px;
      background: var(--panel);
      align-items: center;
      flex-wrap: wrap;
    }
    .nav button, .nav input[type="file"] {
      background: var(--highlight);
      color: #000;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 8px;
    }
    .section {
      display: none;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    .active {
      display: block;
    }
    h2 {
      color: var(--accent);
    }
    h3 {
      color: var(--highlight);
    }
    .panel, .modal-content {
      background: var(--panel);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .xp-bar {
      flex: 1;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      height: 20px;
    }
    .xp-fill {
      height: 100%;
      background: var(--xp-fill);
      text-align: right;
      padding-right: 10px;
      color: #000;
      font-weight: bold;
      transition: width 0.4s ease;
    }
    ul { list-style: none; padding: 0; }
    li {
      background: #2a2a3a;
      padding: 10px;
      border-radius: 8px;
      margin: 8px 0;
      cursor: pointer;
      display: flex; /* Flexbox for alignment */
      justify-content: space-between; /* Space out text and "days left" */
      align-items: center;
    }
    li.done {
        opacity: 0.6; /* Indicate completed quests, but keep them visible (optional) */
        text-decoration: line-through;
        cursor: default;
    }
    .shop-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px; /* Spacing for shop items */
    }
    .shop-menu button {
        background: var(--panel);
        color: var(--text);
        border: 1px solid var(--highlight);
        padding: 8px 16px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 8px;
        margin-right: 10px;
    }
    .shop-submenu {
        display: none; /* Subpages in shop are hidden by default */
    }
    .shop-submenu.active {
        display: block;
    }
    /* Styles for tables within info section */
    .info-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        color: var(--text);
    }
    .info-table th, .info-table td {
        border: 1px solid #333;
        padding: 8px;
        text-align: left;
    }
    .info-table th {
        background-color: #333;
        color: var(--highlight);
    }
    .info-table tr:nth-child(even) {
        background-color: #2a2a3a;
    }

    /* Modale stijlen voor de Ja/Nee-pop-up */
    .modal {
      display: flex; /* Gebruik flexbox voor centrering wanneer actief, maar start onzichtbaar */
      position: fixed; /* Zorgt ervoor dat het over de content heen ligt */
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8); /* Semi-transparante overlay */
      justify-content: center;
      align-items: center;
      z-index: 1000; /* Zorg dat de modal bovenop alles ligt */

      /* Belangrijk voor initiële verbergen zonder display: none; conflict */
      visibility: hidden; /* Start met onzichtbaar */
      opacity: 0; /* Start met volledig transparant */
      transition: opacity 0.3s ease, visibility 0.3s ease; /* Zachte overgang */
    }

    /* De 'active' klasse maakt de modal zichtbaar */
    .modal.active {
      visibility: visible;
      opacity: 1;
    }

    .modal-content {
      background: var(--panel);
      padding: 20px; /* Iets meer padding voor betere uitstraling */
      border-radius: 10px;
      max-width: 90%; /* Zorgt dat het niet te breed wordt op kleine schermen */
      width: 400px; /* Een vaste breedte voor consistentie op grotere schermen */
      box-shadow: 0 5px 15px rgba(0,0,0,0.5); /* Een kleine schaduw */
      text-align: center; /* Centreer de tekst en knoppen binnen de modal */
    }

    .modal-content button {
      margin: 10px;
      padding: 10px 20px; /* Grotere knoppen */
      font-weight: bold;
      background: var(--highlight);
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em; /* Zorg voor leesbare tekst op knoppen */
    }
  </style>
</head>
<body>
  <div class="xp-bar-container">
    <div class="xp-bar"><div class="xp-fill" id="xpFill">0 XP</div></div>
  </div>
  <div class="nav">
    <button onclick="showPage('status')">Status</button>
    <button onclick="showPage('quests')">Quests</button>
    <button onclick="showPage('shop')">Shop</button>
    <button onclick="showPage('generalInfo')">Info</button> <button onclick="saveProgress()">Save Progress</button>
    <input type="file" onchange="loadProgress(event)">
  </div>

  <div id="status" class="section active">
    <h2>Status</h2>
    <div class="panel">
      <p><strong>Level:</strong> <span id="level">1</span></p>
      <p><strong>Points:</strong> <span id="points">0</span></p>
      <p><strong>Gold:</strong> <span id="gold">0</span></p> <p><strong>Current Rank:</strong> <span id="rank">F</span></p>
      <p><strong>Available Ranks:</strong> F, E, D, C, B, A, S, S+, S++</p>
    </div>
  </div>

  <div id="quests" class="section">
    <h2>Daily Quests</h2>
    <ul id="dailyList"></ul>
    <h2>Special Quests</h2>
    <ul id="specialList"></ul>
    <h2>Streak Challenges</h2> <ul id="streakList"></ul>
  </div>

  <div id="shop" class="section">
    <h2>Shop</h2>
    <div class="panel shop-menu active"> <p>You have <strong><span id="shopPoints">0</span> points</strong> and <strong><span id="shopGold">0</span> Gold</strong>.</p>
      <button onclick="showShopPage('rankUpgrades')">Rank Upgrades</button>
      <button onclick="showShopPage('currencyExchange')">Currency Exchange</button>
      <button onclick="showShopPage('realLifeRewards')">Real-Life Rewards</button>
      </div>

    <div id="rankUpgrades" class="panel shop-submenu">
      <h3>Rank Upgrades</h3>
      <ul id="rankUpgradeList">
        </ul>
      <button onclick="showShopPage('mainShop')">Back to Shop</button>
    </div>

    <div id="currencyExchange" class="panel shop-submenu">
      <h3>Currency Exchange</h3>
      <p>Convert your Points into Gold for special rewards!</p>
      <div class="shop-item">
        <span>100 Points = 1 Gold</span>
        <button onclick="convertPointsToGold()">Convert</button>
      </div>
      <button onclick="showShopPage('mainShop')">Back to Shop</button>
    </div>

    <div id="realLifeRewards" class="panel shop-submenu">
      <h3>Real-Life Rewards</h3>
      <p>Purchase these rewards with Gold for a real-life treat! (Self-enforced)</p>
      <ul id="realLifeRewardsList">
        </ul>
      <button onclick="showShopPage('mainShop')">Back to Shop</button>
    </div>
  </div>

  <div id="generalInfo" class="section">
    <h2>Game Information & Progression Guide</h2>
    <div class="panel">
        <h3>Welcome, Adventurer!</h3>
        <p>This application is designed to help you track and gamify your daily habits and personal challenges. By completing quests, you earn **XP (Experience Points)**, **Points**, and **Gold**, allowing you to level up, increase your rank, and unlock special rewards!</p>

        <h3>Level & XP System</h3>
        <p>Your **Level** represents your overall progress and dedication. You earn XP by completing any type of quest. The amount of XP required to reach the next level increases as you level up, ensuring a balanced progression.</p>
        <p><strong>XP Needed per Level:</strong></p>
        <table class="info-table">
            <thead>
                <tr><th>From Level</th><th>To Level</th><th>XP Needed</th><th>Cumulative XP</th></tr>
            </thead>
            <tbody>
                <tr><td>1</td><td>2</td><td>200</td><td>200</td></tr>
                <tr><td>2</td><td>3</td><td>400</td><td>600</td></tr>
                <tr><td>3</td><td>4</td><td>600</td><td>1200</td></tr>
                <tr><td>4</td><td>5</td><td>800</td><td>2000</td></tr>
                <tr><td>5</td><td>6</td><td>1000</td><td>3000</td></tr>
                <tr><td>...</td><td>...</td><td>(Level * 200)</td><td>...</td></tr>
            </tbody>
        </table>

        <h3>Quests: Your Path to Power</h3>
        <p>There are three types of quests, each serving a unique purpose:</p>
        <ul>
            <li><strong>Daily Quests:</strong> These are your essential daily habits (e.g., brushing teeth, taking meds). They offer small amounts of XP and Points, but reset every day at midnight, rewarding consistency.</li>
            <li><strong>Special Quests:</strong> These are larger, one-time tasks (e.g., cleaning your desk, exercising). They offer substantial XP and Points, but are active for 3 days and refresh every 3 days with new challenges.</li>
            <li><strong>Streak Challenges:</strong> These are long-term achievements that reward your consistent completion of specific daily quests for a set number of consecutive days (e.g., brushing teeth 7 days in a row). They offer significant XP, Points, and are the primary way to earn **Gold**. Once completed, they cannot be done again.</li>
        </ul>

        <h3>Rank System: Ascend to Greater Heights!</h3>
        <p>Your **Rank** (from F to S++) signifies your mastery and provides a bonus to the XP and Points you earn from quests. Higher ranks mean faster progress!</p>
        <p><strong>Rank Upgrades:</strong> To advance to the next rank, you must meet two criteria:</p>
        <ol>
            <li>Reach a **specific minimum Level**.</li>
            <li>Pay a **specific amount of Points**.</li>
        </ol>
        <p>This ensures balanced growth – you need to be both experienced (Level) and active (Points) to climb the ranks.</p>
        <p><strong>Rank Upgrade Requirements:</strong></p>
        <table class="info-table">
            <thead>
                <tr><th>From Rank</th><th>To Rank</th><th>Min. Level</th><th>Points Cost</th></tr>
            </thead>
            <tbody id="rankUpgradeInfoTableBody">
                </tbody>
        </table>

        <h3>Currency: Points & Gold</h3>
        <ul>
            <li><strong>Points:</strong> Earned from all quests. Primarily used to upgrade your Rank.</li>
            <li><strong>Gold:</strong> A rare currency earned specifically from completing **Streak Challenges**. Gold is used to purchase valuable **Real-Life Rewards** in the shop.</li>
        </ul>
        <p>You can also **convert Points to Gold** in the shop at a rate of 100 Points = 1 Gold, offering an alternative way to acquire this precious currency.</p>
    </div>
    <button onclick="showPage('status')">Back to Status</button>
  </div>

  <div class="modal" id="questModal">
    <div class="modal-content panel">
      <p id="modalText"></p>
      <button onclick="confirmQuest(true)">Yes</button>
      <button onclick="confirmQuest(false)">No</button>
    </div>
  </div>

  <script>
    const ranks = ["F", "E", "D", "C", "B", "A", "S", "S+", "S++"];
    const rankMultiplier = [
        1,    // F-Rank: 0% bonus (basis)
        1.05, // E-Rank: 5% bonus
        1.1,  // D-Rank: 10% bonus
        1.15, // C-Rank: 15% bonus
        1.2,  // B-Rank: 20% bonus
        1.25, // A-Rank: 25% bonus
        1.3,  // S-Rank: 30% bonus
        1.35, // S+-Rank: 35% bonus
        1.4   // S++-Rank: 40% bonus
    ];

    const rankLevelRequirements = [
        1,   // F-Rank start op Level 1 (of je bent al Level 1)
        2,   // E-Rank vereist Level 2 (om van F naar E te gaan)
        4,   // D-Rank vereist Level 4 (om van E naar D te gaan)
        7,   // C-Rank vereist Level 7
        10,  // B-Rank vereist Level 10
        14,  // A-Rank vereist Level 14
        18,  // S-Rank vereist Level 18
        23,  // S+-Rank vereist Level 23
        29   // S++-Rank vereist Level 29
    ];

    let data = {
      level: 1,
      xp: 0,
      points: 0,
      gold: 0,
      rank: 0,
      dailyQuests: [
        { id: 'brush_teeth_1', text: "Brush teeth (morning)", xp: 10, points: 2, done: false },
        { id: 'brush_teeth_2', text: "Brush teeth (evening)", xp: 10, points: 2, done: false },
        { id: 'take_meds', text: "Take meds (in less than 10 min)", xp: 15, points: 3, done: false },
        { id: 'limit_pmo', text: "Stay under 1.5h PMO total today", xp: 25, points: 10, done: false },
        { id: 'fresh_air', text: "Get fresh air (5 min outside or near window)", xp: 10, points: 3, done: false },
        { id: 'short_stretch', text: "Stretch or move for 1-2 minutes", xp: 15, points: 3, done: false },
        { id: 'short_workout', text: "Short workout (1–3 min, light effort)", xp: 20, points: 4, done: false }
      ],
      allSpecialQuests: [
        { text: "Clean desk", xp: 80, points: 20 },
        { text: "Exercise for 30min", xp: 100, points: 25 },
        { text: "Learn something new (1hr)", xp: 150, points: 35 },
        { text: "Organize files", xp: 120, points: 30 },
        { text: "Cook a healthy meal", xp: 110, points: 28 },
        { text: "Read a book (30min)", xp: 100, points: 22 },
        { text: "Practice a hobby", xp: 130, points: 32 },
        { text: "Deep clean room", xp: 200, points: 50 },
        { text: "Complete significant project", xp: 300, points: 75 }
      ],
      activeSpecials: [],
      lastDailyReset: new Date().toDateString(),
      lastSpecialReset: new Date().toDateString(),
      realLifeRewards: [
        { id: 'gaming_hour', text: "1 hour of gaming", cost: 10, bought: false },
        { id: 'favorite_meal', text: "Order your favorite meal", cost: 25, bought: false },
        { id: 'new_book', text: "Buy a new book", cost: 50, bought: false },
        { id: 'day_off', text: "Take a full day off work/tasks", cost: 100, bought: false },
        { id: 'weekend_trip', text: "Plan a weekend getaway", cost: 250, bought: false }
      ],
      dailyStreaks: {
        'brush_teeth_daily': { current: 0, lastCompletionDate: null },
        'take_meds_daily': { current: 0, lastCompletionDate: null }
      },
      streakQuests: [
        { id: 'brush_7_days', parentQuestId: 'brush_teeth_daily', threshold: 7, text: "Brush teeth 7 days in a row", xp: 500, points: 100, gold: 5, done: false },
        { id: 'brush_14_days', parentQuestId: 'brush_teeth_daily', threshold: 14, text: "Brush teeth 14 days in a row", xp: 1000, points: 200, gold: 10, done: false },
        { id: 'brush_30_days', parentQuestId: 'brush_teeth_daily', threshold: 30, text: "Brush teeth 1 month in a row", xp: 2500, points: 500, gold: 25, done: false },
        { id: 'meds_2_days', parentQuestId: 'take_meds_daily', threshold: 2, text: "Took meds 2 days in a row", xp: 150, points: 30, gold: 2, done: false },
        { id: 'meds_4_days', parentQuestId: 'take_meds_daily', threshold: 4, text: "Took meds 4 days in a row", xp: 300, points: 60, gold: 4, done: false },
        { id: 'meds_7_days', parentQuestId: 'take_meds_daily', threshold: 7, text: "Took meds 1 week in a row", xp: 600, points: 120, gold: 8, done: false },
        { id: 'meds_14_days', parentQuestId: 'take_meds_daily', threshold: 14, text: "Took meds 2 weeks in a row", xp: 1200, points: 240, gold: 15, done: false },
        { id: 'meds_30_days', parentQuestId: 'take_meds_daily', threshold: 30, text: "Took meds 1 month in a row", xp: 3000, points: 600, gold: 30, done: false }
      ]
    };

    let currentQuestType = null;
    let currentQuestIndex = null;

    // --- Core UI & Logic Functions ---

    function updateUI() {
      document.getElementById("level").textContent = data.level;
      document.getElementById("points").textContent = data.points;
      document.getElementById("gold").textContent = data.gold; // Update Gold display in Status
      document.getElementById("shopPoints").textContent = data.points;
      document.getElementById("shopGold").textContent = data.gold; // Update Gold display in Shop
      document.getElementById("rank").textContent = ranks[data.rank];

      let xpNeeded = data.level * 200;
      let percent = Math.min((data.xp / xpNeeded) * 100, 100);
      let fill = document.getElementById("xpFill");
      fill.style.width = percent + "%";
      fill.textContent = `${data.xp} / ${xpNeeded} XP`;

      // Daily Quests UI
      const dList = document.getElementById("dailyList");
      dList.innerHTML = "";
      data.dailyQuests.forEach((q, i) => {
        const li = document.createElement("li");
        li.textContent = `${q.text} (+${q.xp} XP / +${q.points}P)`;
        if (q.done) {
          li.classList.add('done');
        } else {
          li.onclick = () => openModal("daily", i);
        }
        dList.appendChild(li);
      });

      // Special Quests UI
      const sList = document.getElementById("specialList");
      sList.innerHTML = "";
      data.activeSpecials.forEach((q, i) => {
        const li = document.createElement("li");
        let daysLeftText = q.daysLeft > 0 ? ` – ${q.daysLeft} day${q.daysLeft !== 1 ? 's' : ''} left` : ' – Expired';
        li.textContent = `${q.text} (+${q.xp} XP / +${q.points}P)`;
        const spanDaysLeft = document.createElement('span');
        spanDaysLeft.textContent = daysLeftText;
        li.appendChild(spanDaysLeft);

        if (q.done || q.daysLeft <= 0) {
          li.classList.add('done');
        } else {
          li.onclick = () => openModal("special", i);
        }
        sList.appendChild(li);
      });

      // Streak Quests UI
      const streakList = document.getElementById("streakList");
      streakList.innerHTML = "";
      data.streakQuests.forEach((q, i) => {
          const li = document.createElement("li");
          li.textContent = `${q.text} (+${q.xp} XP / +${q.points}P / +${q.gold} Gold)`;
          if (q.done) {
              li.classList.add('done');
          } else {
              const parentStreak = data.dailyStreaks[q.parentQuestId];
              if (parentStreak) {
                  const currentProgress = parentStreak.current;
                  li.textContent += ` (Current streak: ${currentProgress}/${q.threshold} days)`;
              }
              li.style.cursor = 'default';
          }
          streakList.appendChild(li);
      });

      // Update Shop lijsten
      updateRankUpgradeList();
      updateRealLifeRewardsList();

      // Update Info Table (for Rank Upgrades) - Zorgt dat de tabel in Info gevuld is als Info actief is
      updateRankUpgradeInfoTable();
    }

    function openModal(type, index) {
      const list = type === "daily" ? data.dailyQuests : data.activeSpecials;
      const q = list[index];

      // Voorkom openen als al gedaan of verlopen
      if (q.done || (type === "special" && q.daysLeft <= 0)) {
        return;
      }

      currentQuestType = type;
      currentQuestIndex = index;
      document.getElementById("modalText").textContent = `Did you complete: ${q.text}?`;
      
      const questModal = document.getElementById("questModal");
      // Voeg nu de 'active' klasse toe om de modal zichtbaar te maken via CSS
      questModal.classList.add('active'); 
    }

    function confirmQuest(yes) {
      const questModal = document.getElementById("questModal");
      // Verwijder de 'active' klasse om de modal te verbergen via CSS
      questModal.classList.remove('active'); 

      if (yes) {
        const list = currentQuestType === "daily" ? data.dailyQuests : data.activeSpecials;
        const q = list[currentQuestIndex];

        if (!q.done && !(currentQuestType === "special" && q.daysLeft <= 0)) {
          q.done = true;
          data.xp += Math.floor(q.xp * rankMultiplier[data.rank]);
          data.points += Math.floor(q.points * rankMultiplier[data.rank]);
          checkLevelUp();
          
          if (currentQuestType === "daily") {
              checkStreaks(q.id); 
          }

          updateUI();
          console.log(`Quest "${q.text}" completed!`);
        }
      }
    }

    function checkLevelUp() {
      let needed = data.level * 200;
      while (data.xp >= needed) {
        data.xp -= needed;
        data.level++;
        needed = data.level * 200;
        console.log(`Level Up! You are now Level ${data.level}!`);
      }
    }

    // Functie om de hoofd-navigatiepagina's te tonen
    function showPage(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      // Wanneer je naar de shop navigeert, zorg dat de hoofd-shop pagina actief is
      if (id === 'shop') {
          showShopPage('mainShop');
      }
      // Wanneer je naar Info navigeert, zorg dat de Info tabel wordt bijgewerkt
      if (id === 'generalInfo') {
          updateRankUpgradeInfoTable();
      }
    }

    // Functie om te navigeren binnen de shop subpagina's
    function showShopPage(id) {
        document.querySelectorAll('.shop-menu, .shop-submenu').forEach(sec => sec.classList.remove('active'));
        if (id === 'mainShop') {
            document.querySelector('.shop-menu').classList.add('active');
        } else {
            document.getElementById(id).classList.add('active');
        }
    }

    function getRankUpgradeCost(targetRankIndex) {
      const baseCost = 1000;
      return baseCost + (targetRankIndex * 1500);
    }

    function updateRankUpgradeList() {
        const rankList = document.getElementById("rankUpgradeList");
        rankList.innerHTML = "";

        for (let i = 0; i < ranks.length - 1; i++) {
            const currentRank = ranks[i];
            const nextRank = ranks[i + 1];
            const upgradeLevelRequired = rankLevelRequirements[i + 1];
            const upgradePointsCost = getRankUpgradeCost(i + 1);

            const li = document.createElement("li");
            li.innerHTML = `
                <span>Upgrade from <strong>${currentRank}</strong> to <strong>${nextRank}</strong> Rank:</span><br>
                <span>Requires: Level ${upgradeLevelRequired}, ${upgradePointsCost} Points</span>
            `;

            const buyButton = document.createElement("button");
            buyButton.textContent = "Buy";
            buyButton.onclick = () => buyRankUpgrade(i);
            
            if (data.rank === i) {
                if (data.level >= upgradeLevelRequired && data.points >= upgradePointsCost) {
                    buyButton.disabled = false;
                } else {
                    buyButton.disabled = true;
                }
            } else if (data.rank > i) {
                buyButton.textContent = "Achieved";
                buyButton.disabled = true;
                li.classList.add('done');
            } else {
                buyButton.textContent = "Locked";
                buyButton.disabled = true;
            }

            li.appendChild(buyButton);
            rankList.appendChild(li);
        }
    }

    function buyRankUpgrade(targetRankIndex) {
        if (data.rank !== targetRankIndex) {
            alert("You can only upgrade to your next immediate rank.");
            return;
        }

        const nextRankIndex = data.rank + 1;
        if (nextRankIndex >= ranks.length) {
            alert("You are already at the highest rank!");
            return;
        }

        const upgradeCost = getRankUpgradeCost(nextRankIndex);
        const requiredLevel = rankLevelRequirements[nextRankIndex];
        const nextRankName = ranks[nextRankIndex];

        if (data.level >= requiredLevel) {
            if (data.points >= upgradeCost) {
                data.points -= upgradeCost;
                data.rank++;
                alert(`Congratulations! You are now Rank ${nextRankName}!`);
                updateUI();
            } else {
                alert(`Not enough points! You need ${upgradeCost} points to upgrade to Rank ${nextRankName}.`);
            }
        } else {
            alert(`You need to reach Level ${requiredLevel} to upgrade to Rank ${nextRankName}.`);
        }
    }

    function convertPointsToGold() {
        const pointsToConvert = 100;
        const goldToGain = 1;

        if (data.points >= pointsToConvert) {
            data.points -= pointsToConvert;
            data.gold += goldToGain;
            alert(`You converted ${pointsToConvert} Points into ${goldToGain} Gold!`);
            updateUI();
        } else {
            alert(`You need at least ${pointsToConvert} Points to convert to Gold.`);
        }
    }

    function updateRealLifeRewardsList() {
        const rewardsList = document.getElementById("realLifeRewardsList");
        rewardsList.innerHTML = "";

        data.realLifeRewards.forEach(reward => {
            const li = document.createElement("li");
            li.innerHTML = `<span>${reward.text}</span>`;

            const buyButton = document.createElement("button");
            if (reward.bought) {
                buyButton.textContent = "Claimed";
                buyButton.disabled = true;
                li.classList.add('done');
            } else {
                buyButton.textContent = `Buy (${reward.cost} Gold)`;
                buyButton.disabled = data.gold < reward.cost;
                buyButton.onclick = () => buyRealLifeReward(reward.id);
            }
            li.appendChild(buyButton);
            rewardsList.appendChild(li);
        });
    }

    function buyRealLifeReward(rewardId) {
        const reward = data.realLifeRewards.find(r => r.id === rewardId);

        if (reward && !reward.bought) {
            if (data.gold >= reward.cost) {
                data.gold -= reward.cost;
                reward.bought = true;
                alert(`Reward purchased! Enjoy your "${reward.text}"!`);
                updateUI();
            } else {
                alert(`Not enough Gold! You need ${reward.cost} Gold to buy "${reward.text}".`);
            }
        }
    }

    // --- Streak Quest Logica ---

    function checkStreaks(completedDailyQuestId) {
        const today = new Date().toDateString();

        // Logica voor Brush Teeth Streak (als EEN van de tandenpoets quests is gedaan)
        if (completedDailyQuestId === 'brush_teeth_1' || completedDailyQuestId === 'brush_teeth_2') {
            const brushStreak = data.dailyStreaks['brush_teeth_daily'];
            if (brushStreak.lastCompletionDate !== today) {
                updateSingleStreak('brush_teeth_daily', today);
            }
        }

        // Logica voor Take Meds Streak
        if (completedDailyQuestId === 'take_meds') {
            updateSingleStreak('take_meds_daily', today);
        }

        // Controleer alle streak quests en beloon indien voltooid
        data.streakQuests.forEach(streakQuest => {
            if (!streakQuest.done && data.dailyStreaks[streakQuest.parentQuestId] && data.dailyStreaks[streakQuest.parentQuestId].current >= streakQuest.threshold) {
                streakQuest.done = true;
                data.xp += streakQuest.xp;
                data.points += streakQuest.points;
                data.gold += streakQuest.gold;
                checkLevelUp();
                alert(`STREAK COMPLETED! You earned a reward for "${streakQuest.text}"! (+${streakQuest.xp} XP / +${streakQuest.points} P / +${streakQuest.gold} Gold)`);
                console.log(`Streak Quest "${streakQuest.text}" completed!`);
            }
        });
    }

    function updateSingleStreak(streakKey, today) {
        let streak = data.dailyStreaks[streakKey];
        if (!streak) {
            streak = { current: 0, lastCompletionDate: null };
            data.dailyStreaks[streakKey] = streak;
        }

        const lastDate = streak.lastCompletionDate ? new Date(streak.lastCompletionDate) : null;
        const currentDate = new Date(today);

        if (lastDate && currentDate.toDateString() === lastDate.toDateString()) {
            return;
        }

        if (lastDate && (currentDate.getTime() - lastDate.getTime()) === (24 * 60 * 60 * 1000)) {
            streak.current++;
        } else if (lastDate && (currentDate.getTime() - lastDate.getTime()) > (24 * 60 * 60 * 1000)) {
            streak.current = 1;
        } else {
            streak.current = 1;
        }
        streak.lastCompletionDate = today;
        console.log(`${streakKey} streak updated to: ${streak.current}`);
    }


    function saveProgress() {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'progress.json';
      a.click();
      URL.revokeObjectURL(a.href);
      console.log("Progress saved to progress.json");
    }

    function loadProgress(e) {
      const file = e.target.files[0];
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const loadedData = JSON.parse(ev.target.result);
          
          data = {
            ...data,
            ...loadedData
          };

          if (loadedData.realLifeRewards) {
              const mergedRewards = data.realLifeRewards.map(defaultReward => {
                  const loadedReward = loadedData.realLifeRewards.find(lr => lr.id === defaultReward.id);
                  return loadedReward ? { ...defaultReward, ...loadedReward } : defaultReward;
              });
              loadedData.realLifeRewards.forEach(loadedReward => {
                  if (!mergedRewards.some(mr => mr.id === loadedReward.id)) {
                      mergedRewards.push(loadedReward);
                  }
              });
              data.realLifeRewards = mergedRewards;
          }

          if (loadedData.streakQuests) {
            const mergedStreakQuests = data.streakQuests.map(defaultStreakQuest => {
                const loadedStreakQuest = loadedData.streakQuests.find(lsq => lsq.id === defaultStreakQuest.id);
                return loadedStreakQuest ? { ...defaultStreakQuest, ...loadedStreakQuest } : defaultStreakQuest;
            });
            loadedData.streakQuests.forEach(loadedStreakQuest => {
                if (!mergedStreakQuests.some(msq => msq.id === loadedStreakQuest.id)) {
                    mergedStreakQuests.push(loadedStreakQuest);
                }
            });
            data.streakQuests = mergedStreakQuests;
          }

          if (!data.dailyStreaks) {
              data.dailyStreaks = {
                  'brush_teeth_daily': { current: 0, lastCompletionDate: null },
                  'take_meds_daily': { current: 0, lastCompletionDate: null }
              };
          } else {
              if (!data.dailyStreaks['brush_teeth_daily']) data.dailyStreaks['brush_teeth_daily'] = { current: 0, lastCompletionDate: null };
              if (!data.dailyStreaks['take_meds_daily']) data.dailyStreaks['take_meds_daily'] = { current: 0, lastCompletionDate: null };
          }


          console.log("Progress successfully loaded!");
          performDailyAndSpecialResets();
          updateUI();
        } catch (error) {
          alert("Error loading progress: Invalid file or data format. Please select a valid .json file.");
          console.error("Loading error:", error);
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    // --- Info Table (Rank Upgrades) Logic ---
    function updateRankUpgradeInfoTable() {
        // Zorg dat de tabel alleen wordt bijgewerkt als de generalInfo sectie actief is
        const generalInfoSection = document.getElementById("generalInfo");
        if (!generalInfoSection || !generalInfoSection.classList.contains('active')) {
            return;
        }

        const tableBody = document.getElementById("rankUpgradeInfoTableBody");
        if (!tableBody) return; 
        tableBody.innerHTML = "";

        // Start from F-rank and go up to S+ (because S++ is max and has no next rank)
        for (let i = 0; i < ranks.length - 1; i++) {
            const currentRank = ranks[i];
            const nextRank = ranks[i + 1];
            const requiredLevel = rankLevelRequirements[i + 1];
            const pointsCost = getRankUpgradeCost(i + 1);

            const row = tableBody.insertRow();
            row.insertCell().textContent = currentRank;
            row.insertCell().textContent = nextRank;
            row.insertCell().textContent = `Level ${requiredLevel}`;
            row.insertCell().textContent = `${pointsCost} Points`;
        }
    }


    // --- Reset Functies ---

    function checkDailyReset() {
      const today = new Date().toDateString();
      if (data.lastDailyReset !== today) {
        data.dailyQuests.forEach(q => q.done = false);
        data.lastDailyReset = today;
        
        for (const key in data.dailyStreaks) {
            const streak = data.dailyStreaks[key];
            if (streak.lastCompletionDate) {
                const lastDate = new Date(streak.lastCompletionDate);
                const currentDate = new Date(today);
                const diffTime = currentDate.getTime() - lastDate.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays > 1) {
                    streak.current = 0;
                    console.log(`Streak for ${key} broken. Reset to 0.`);
                }
            } else {
                streak.current = 0;
            }
        }
        console.log("Daily quests have been reset to undone!");
      }
    }

    function resetSpecials() {
      const today = new Date();
      const lastSpecialResetDate = new Date(data.lastSpecialReset);

      const diffTime = Math.abs(today.getTime() - lastSpecialResetDate.getTime());
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays >= 3 || data.activeSpecials.length === 0) {
        data.activeSpecials = [];
        const availableQuests = [...data.allSpecialQuests];
        for (let i = availableQuests.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [availableQuests[i], availableQuests[j]] = [availableQuests[j], availableQuests[i]];
        }

        for (let i = 0; i < 5; i++) {
          if (availableQuests.length === 0) break;
          const newQuest = { ...availableQuests.shift(), daysLeft: 3, done: false };
          data.activeSpecials.push(newQuest);
        }

        data.lastSpecialReset = today.toDateString();
        console.log("Special quests have been fully reset and 5 new ones selected!");

      } else if (diffDays > 0) {
        data.activeSpecials.forEach(q => {
          if (!q.done && q.daysLeft > 0) {
            q.daysLeft -= diffDays;
          }
        });
        data.activeSpecials = data.activeSpecials.filter(q => q.daysLeft > 0 || q.done);
        console.log(`Special quests days left decremented by ${diffDays} day(s).`);
      }
    }

    function performDailyAndSpecialResets() {
      checkDailyReset();
      resetSpecials();
    }

    // --- Initialisatie ---

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("rank").textContent = ranks[data.rank];
        performDailyAndSpecialResets();
        updateUI(); // Initial UI update after data load and resets
        showPage('status'); // Toon standaard de statuspagina
    });
  </script>
</body>
</html>
