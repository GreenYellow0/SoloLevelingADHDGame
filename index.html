<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Progress Tracker</title>
  <style>
    :root {
      --bg: #0a0a0f;
      --panel: #1e1e2e;
      --accent: #ffcc00;
      --highlight: #00d1ff;
      --text: #f0f0f0;
      --xp-fill: #00ffcc;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .nav, .xp-bar-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 10px;
      background: var(--panel);
      align-items: center;
      flex-wrap: wrap;
    }
    .nav button, .nav input[type="file"] {
      background: var(--highlight);
      color: #000;
      border: none;
      padding: 8px 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 8px;
    }
    .section {
      display: none;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    .active {
      display: block;
    }
    h2 {
      color: var(--accent);
    }
    h3 {
      color: var(--highlight);
    }
    .panel, .modal-content {
      background: var(--panel);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .xp-bar {
      flex: 1;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      height: 20px;
    }
    .xp-fill {
      height: 100%;
      background: var(--xp-fill);
      text-align: right;
      padding-right: 10px;
      color: #000;
      font-weight: bold;
      transition: width 0.4s ease;
    }
    ul { list-style: none; padding: 0; }
    li {
      /* Algemene lijst item styling, zal overschreven worden door .weapon-card of .item-card */
      background: #2a2a3a;
      padding: 10px;
      border-radius: 8px;
      margin: 8px 0;
      cursor: pointer;
      display: flex; /* Flexbox for alignment */
      justify-content: space-between; /* Space out text and "days left" */
      align-items: center;
    }
    li.done {
        opacity: 0.6; /* Indicate completed quests, but keep them visible (optional) */
        text-decoration: line-through;
        cursor: default;
    }
    .shop-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px; /* Spacing for shop items */
    }
    .shop-menu button {
        background: var(--panel);
        color: var(--text);
        border: 1px solid var(--highlight);
        padding: 8px 16px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 8px;
        margin-right: 10px;
    }
    .shop-submenu {
        display: none; /* Subpages in shop are hidden by default */
    }
    .shop-submenu.active {
        display: block;
    }
    /* Styles for tables within info section */
    .info-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        color: var(--text);
    }
    .info-table th, .info-table td {
        border: 1px solid #333;
        padding: 8px;
        text-align: left;
    }
    .info-table th {
        background-color: #333;
        color: var(--highlight);
    }
    .info-table tr:nth-child(even) {
        background-color: #2a2a3a;
    }

    /* Modale stijlen voor de Ja/Nee-pop-up */
    .modal {
      display: flex; /* Gebruik flexbox voor centrering wanneer actief, maar start onzichtbaar */
      position: fixed; /* Zorgt ervoor dat het over de content heen ligt */
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8); /* Semi-transparante overlay */
      justify-content: center;
      align-items: center;
      z-index: 1000; /* Zorg dat de modal bovenop alles ligt */

      /* Belangrijk voor initiÃ«le verbergen zonder display: none; conflict */
      visibility: hidden; /* Start met onzichtbaar */
      opacity: 0; /* Start met volledig transparant */
      transition: opacity 0.3s ease, visibility 0.3s ease; /* Zachte overgang */
    }

    /* De 'active' klasse maakt de modal zichtbaar */
    .modal.active {
      visibility: visible;
      opacity: 1;
    }

    .modal-content {
      background: var(--panel);
      padding: 20px; /* Iets meer padding voor betere uitstraling */
      border-radius: 10px;
      max-width: 90%; /* Zorgt dat het niet te breed wordt op kleine schermen */
      width: 400px; /* Een vaste breedte voor consistentie op grotere schermen */
      box-shadow: 0 5px 15px rgba(0,0,0,0.5); /* Een kleine schaduw */
      text-align: center; /* Centreer de tekst en knoppen binnen de modal */
    }

    .modal-content button {
      margin: 10px;
      padding: 10px 20px; /* Grotere knoppen */
      font-weight: bold;
      background: var(--highlight);
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em; /* Zorg voor leesbare tekst op knoppen */
    }

    /* Styles voor WAPEN KAARTJES */
    .weapon-card, .item-card { /* Nieuwe .item-card class */
        background: #2a2a3a; /* Achtergrond zoals andere lijst-items */
        border: 1px solid #333; /* Dunne rand */
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex; /* Gebruik flexbox voor lay-out binnen de kaart */
        flex-direction: column; /* Stapel items verticaal */
        align-items: center; /* Centreer horizontaal */
        text-align: center;
        max-width: 180px; /* Max breedte van een kaartje, pas aan indien nodig */
        min-width: 150px; /* Min breedte */
        flex-grow: 1; /* Zorgt dat het kan groeien in een flex container */
        box-sizing: border-box; /* Padding en border binnen de breedte */
    }

    .weapon-card-list { /* Container voor de wapen/item kaartjes */
        display: flex;
        flex-wrap: wrap; /* Laat de kaartjes omvouwen naar de volgende rij */
        gap: 20px; /* Ruimte tussen de kaartjes */
        justify-content: center; /* Centreer de kaartjes in de container */
        padding: 0; /* Verwijder standaard padding van UL */
        list-style: none; /* Verwijder list-style van UL */
    }

    .weapon-item-icon, .item-icon { /* Nieuwe .item-icon class */
        width: 80px; /* Groter icoon voor het kaartje */
        height: 80px;
        margin-bottom: 10px; /* Ruimte onder het icoon */
        image-rendering: crisp-edges; /* Zorgt dat pixel art er scherp uitziet */
        image-rendering: -webkit-crisp-edges; /* Voor Safari */
    }

    .weapon-card-name, .item-card-name {
        font-size: 1.1em;
        font-weight: bold;
        color: var(--accent);
        margin-bottom: 5px;
    }

    .weapon-card-rank, .item-card-cost-display { /* Nieuwe .item-card-cost-display */
        font-size: 0.9em;
        color: var(--highlight);
        margin-bottom: 5px;
    }

    .weapon-card-ability, .item-card-effect { /* Nieuwe .item-card-effect */
        font-size: 0.8em;
        color: var(--text);
        font-style: italic;
        margin-bottom: 10px;
        min-height: 2.4em; /* Zorgt voor consistente hoogte, zelfs bij korte tekst */
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .weapon-card button, .item-card button { /* Stijl de knop binnen het kaartje */
        background: var(--highlight);
        color: #000;
        border: none;
        padding: 8px 12px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 5px;
        font-size: 0.9em;
        width: 100%; /* Knop vult de breedte van het kaartje */
    }
  </style>
</head>
<body>
  <div class="xp-bar-container">
    <div class="xp-bar"><div class="xp-fill" id="xpFill">0 XP</div></div>
  </div>
  <div class="nav">
    <button onclick="showPage('status')">Status</button>
    <button onclick="showPage('quests')">Quests</button>
    <button onclick="showPage('shop')">Shop</button>
    <button onclick="showPage('inventory')">Inventory</button>
    <button onclick="showPage('generalInfo')">Info</button>
    <button onclick="saveProgress()">Save Progress</button>
    <input type="file" onchange="loadProgress(event)">
  </div>

  <div id="status" class="section active">
    <h2>Status</h2>
    <div class="panel">
      <p><strong>Level:</strong> <span id="level">1</span></p>
      <p><strong>Points:</strong> <span id="points">0</span></p>
      <p><strong>Gold:</strong> <span id="gold">0</span></p>
      <p><strong>Silver:</strong> <span id="silver">0</span></p>
      <p><strong>Current Rank:</strong> <span id="rank">F</span></p>
      <p><strong>Available Ranks:</strong> F, E, D, C, B, A, S, S+, S++</p>
    </div>
  </div>

  <div id="quests" class="section">
    <h2>Daily Quests</h2>
    <ul id="dailyList"></ul>
    <h2>Special Quests</h2>
    <ul id="specialList"></ul>
    <h2>Streak Challenges</h2>
    <ul id="streakList"></ul>
  </div>

  <div id="shop" class="section">
    <h2>Shop</h2>
    <div class="panel shop-menu active">
      <p>You have <strong><span id="shopPoints">0</span> points</strong>, <strong><span id="shopGold">0</span> Gold</strong>, and <strong><span id="shopSilver">0</span> Silver</strong>.</p>
      <button onclick="showShopPage('rankUpgrades')">Rank Upgrades</button>
      <button onclick="showShopPage('itemShop')">Item Shop</button> <button onclick="showShopPage('realLifeRewards')">Real-Life Rewards</button>
      <button onclick="showShopPage('weaponShop')">Weapon Shop</button>
    </div>

    <div id="rankUpgrades" class="panel shop-submenu">
      <h3>Rank Upgrades</h3>
      <ul id="rankUpgradeList">
        </ul>
      <button onclick="showShopPage('mainShop')">Back to Shop</button>
    </div>

    <div id="itemShop" class="panel shop-submenu">
      <h3>Item Shop</h3>
      <p>Purchase various items to aid your journey!</p>
      <ul id="itemList" class="weapon-card-list"> </ul>
      <button onclick="showShopPage('mainShop')">Back to Shop</button>
    </div>

    <div id="realLifeRewards" class="panel shop-submenu">
      <h3>Real-Life Rewards</h3>
      <p>Purchase these rewards with Gold for a real-life treat! (Self-enforced)</p>
      <ul id="realLifeRewardsList">
        </ul>
      <button onclick="showShopPage('mainShop')">Back to Shop</button>
    </div>

    <div id="weaponShop" class="panel shop-submenu">
      <h3>Weapon Shop</h3>
      <p>Acquire powerful weapons to aid your journey!</p>
      <ul id="weaponList" class="weapon-card-list"> </ul>
      <button onclick="showShopPage('mainShop')">Back to Shop</button>
    </div>
  </div>

  <div id="inventory" class="section">
    <h2>Inventory</h2>
    <div class="panel">
      <p>Your current arsenal:</p>
      <ul id="inventoryList" class="weapon-card-list"> </ul>
    </div>
  </div>


  <div id="generalInfo" class="section">
    <h2>Game Information & Progression Guide</h2>
    <div class="panel">
        <h3>Welcome, Adventurer!</h3>
        <p>This application is designed to help you track and gamify your daily habits and personal challenges. By completing quests, you earn **XP (Experience Points)**, **Points**, and **Gold**, allowing you to level up, increase your rank, and unlock special rewards!</p>

        <h3>Level & XP System</h3>
        <p>Your **Level** represents your overall progress and dedication. You earn XP by completing any type of quest. The amount of XP required to reach the next level increases as you level up, ensuring a balanced progression.</p>
        <p><strong>XP Needed per Level:</strong></p>
        <table class="info-table">
            <thead>
                <tr><th>From Level</th><th>To Level</th><th>XP Needed</th><th>Cumulative XP</th></tr>
            </thead>
            <tbody>
                <tr><td>1</td><td>2</td><td>200</td><td>200</td></tr>
                <tr><td>2</td><td>3</td><td>400</td><td>600</td></tr>
                <tr><td>3</td><td>4</td><td>600</td><td>1200</td></tr>
                <tr><td>4</td><td>5</td><td>800</td><td>2000</td></tr>
                <tr><td>5</td><td>6</td><td>1000</td><td>3000</td></tr>
                <tr><td>...</td><td>...</td><td>(Level * 200)</td><td>...</td></tr>
            </tbody>
        </table>

        <h3>Quests: Your Path to Power</h3>
        <p>There are three types of quests, each serving a unique purpose:</p>
        <ul>
            <li><strong>Daily Quests:</strong> These are your essential daily habits (e.g., brushing teeth, taking meds). They offer small amounts of XP and Points, but reset every day at midnight, rewarding consistency.</li>
            <li><strong>Special Quests:</strong> These are larger, one-time tasks (e.g., cleaning your desk, exercising). They offer substantial XP and Points, but are active for 3 days and refresh every 3 days with new challenges.</li>
            <li><strong>Streak Challenges:</strong> These are long-term achievements that reward your consistent completion of specific daily quests for a set number of consecutive days (e.g., brushing teeth 7 days in a row). They offer significant XP, Points, and are the primary way to earn **Gold**. Once completed, they cannot be done again.</li>
        </ul>

        <h3>Rank System: Ascend to Greater Heights!</h3>
        <p>Your **Rank** (from F to S++) signifies your mastery and provides a bonus to the XP and Points you earn from quests. Higher ranks mean faster progress!</p>
        <p><strong>Rank Upgrades:</strong> To advance to the next rank, you must meet two criteria:</p>
        <ol>
            <li>Reach a **specific minimum Level**.</li>
            <li>Pay a **specific amount of Points**.</li>
        </ol>
        <p>This ensures balanced growth â you need to be both experienced (Level) and active (Points) to climb the ranks.</p>
        <p><strong>Rank Upgrade Requirements:</strong></p>
        <table class="info-table">
            <thead>
                <tr><th>From Rank</th><th>To Rank</th><th>Min. Level</th><th>Points Cost</th></tr>
            </thead>
            <tbody id="rankUpgradeInfoTableBody">
                </tbody>
        </table>

        <h3>Currency: Points, Silver & Gold</h3>
        <ul>
            <li><strong>Points:</strong> Earned from all quests. Primarily used to upgrade your Rank, or can be used to purchase **Items** in the Item Shop.</li> <li><strong>Silver:</strong> A common currency used to purchase certain items, especially weapons for lower ranks (F-C) and some special **Items**. You can earn Silver by purchasing specific Items with Points.</li> <li><strong>Gold:</strong> A rare currency earned specifically from completing **Streak Challenges**. Gold is used to purchase valuable **Real-Life Rewards** and advanced weapons for higher ranks (B-S++). You can also earn Gold by purchasing specific Items with Points or Silver.</li> </ul>
        
        <h3>Item Shop: Strategic Purchases!</h3> <p>The Item Shop offers unique purchases that provide immediate benefits or help you convert lower-value currency into higher-value currency. These items are consumed upon purchase and do not appear in your Inventory.</p>
        <p>Current items available:</p>
        <ul>
            <li><strong>Diamond Item:</strong> Spend 100 Points to instantly gain 1 Gold. (Repeatable)</li>
            <li><strong>Mana Crystal:</strong> Spend 10 Points to instantly gain 50 Silver. (Repeatable)</li>
            <li><strong>Advanced Mana Crystal:</strong> Spend 1000 Silver to instantly gain 250 XP. (Repeatable)</li>
        </ul>
        <p>Strategically use these items to manage your resources and accelerate your progress!</p>

        <h3>Weapons: Enhance Your Collection!</h3>
        <p>Weapons are collectible items that you can purchase from the Weapon Shop using Silver or Gold. Each weapon is associated with a specific Rank. You must achieve that Rank before you can purchase the weapon. Collecting all weapons will grant you a significant bonus reward!</p>
        <p><strong>Weapon Costs and Requirements:</strong></p>
        <ul>
            <li>Weapons for **F-Rank through C-Rank** are purchased using **Silver**.</li>
            <li>Weapons for **B-Rank through S++-Rank** are purchased using **Gold**.</li>
        </ul>
        <p>Upon collecting **all** weapons, you will receive a grand bonus of <strong>2000 XP, 500 Points, 100 Gold, and 2000 Silver!</strong></p>
    </div>
    <button onclick="showPage('status')">Back to Status</button>
  </div>

  <div class="modal" id="questModal">
    <div class="modal-content panel">
      <p id="modalText"></p>
      <button onclick="confirmQuest(true)">Yes</button>
      <button onclick="confirmQuest(false)">No</button>
    </div>
  </div>

  <script>
    const ranks = ["F", "E", "D", "C", "B", "A", "S", "S+", "S++"];
    const rankMultiplier = [
        1,    // F-Rank: 0% bonus (basis)
        1.05, // E-Rank: 5% bonus
        1.1,  // D-Rank: 10% bonus
        1.15, // C-Rank: 15% bonus
        1.2,  // B-Rank: 20% bonus
        1.25, // A-Rank: 25% bonus
        1.3,  // S-Rank: 30% bonus
        1.35, // S+-Rank: 35% bonus
        1.4   // S++-Rank: 40% bonus
    ];

    const rankLevelRequirements = [
        1,   // F-Rank start op Level 1 (of je bent al Level 1)
        2,   // E-Rank vereist Level 2 (om van F naar E te gaan)
        4,   // D-Rank vereist Level 4 (om van E naar D te gaan)
        7,   // C-Rank vereist Level 7
        10,  // B-Rank vereist Level 10
        14,  // A-Rank vereist Level 14
        18,  // S-Rank vereist Level 18
        23,  // S+-Rank vereist Level 23
        29   // S++-Rank vereist Level 29
    ];

    // De standaard (hardcoded) staat van de app als er geen save-bestand is geladen
    // of als nieuwe velden moeten worden geÃ¯nitialiseerd.
    const defaultData = {
      level: 1,
      xp: 0,
      points: 0,
      gold: 0,
      silver: 0, // NIEUW: Zilver valuta
      rank: 0,
      dailyQuests: [
        { id: 'brush_teeth_1', text: "Brush teeth (morning)", xp: 10, points: 2, done: false },
        { id: 'brush_teeth_2', text: "Brush teeth (evening)", xp: 10, points: 2, done: false },
        { id: 'take_meds', text: "Take meds (in less than 10 min)", xp: 15, points: 3, done: false },
        { id: 'limit_pmo', text: "Stay under 1.5h PMO total today", xp: 25, points: 10, done: false }, 
        { id: 'fresh_air', text: "Get fresh air (5 min outside or near window)", xp: 10, points: 3, done: false }, 
        { id: 'short_stretch', text: "Stretch or move for 1-2 minutes", xp: 15, points: 3, done: false }, 
        { id: 'short_workout', text: "Short workout (1â3 min, light effort)", xp: 20, points: 4, done: false } 
      ],
      allSpecialQuests: [
        { text: "Clean desk", xp: 80, points: 20 },
        { text: "Exercise for 30min", xp: 100, points: 25 },
        { text: "Learn something new (1hr)", xp: 150, points: 35 },
        { text: "Organize files", xp: 120, points: 30 },
        { text: "Cook a healthy meal", xp: 110, points: 28 },
        { text: "Read a book (30min)", xp: 100, points: 22 },
        { text: "Practice a hobby", xp: 130, points: 32 },
        { text: "Deep clean room", xp: 200, points: 50 },
        { text: "Complete significant project", xp: 300, points: 75 }
      ],
      activeSpecials: [],
      lastDailyReset: new Date().toDateString(),
      lastSpecialReset: new Date().toDateString(),
      realLifeRewards: [
        { id: 'gaming_hour', text: "1 hour of gaming", cost: 10, bought: false },
        { id: 'favorite_meal', text: "Order your favorite meal", cost: 25, bought: false },
        { id: 'new_book', text: "Buy a new book", cost: 50, bought: false },
        { id: 'day_off', text: "Take a full day off work/tasks", cost: 100, bought: false },
        { id: 'weekend_trip', text: "Plan a weekend getaway", cost: 250, bought: false }
      ],
      dailyStreaks: {
        'brush_teeth_daily': { current: 0, lastCompletionDate: null },
        'take_meds_daily': { current: 0, lastCompletionDate: null }
      },
      streakQuests: [
        { id: 'brush_7_days', parentQuestId: 'brush_teeth_daily', threshold: 7, text: "Brush teeth 7 days in a row", xp: 500, points: 100, gold: 5, done: false },
        { id: 'brush_14_days', parentQuestId: 'brush_teeth_daily', threshold: 14, text: "Brush teeth 14 days in a row", xp: 1000, points: 200, gold: 10, done: false },
        { id: 'brush_30_days', parentQuestId: 'brush_teeth_daily', threshold: 30, text: "Brush teeth 1 month in a row", xp: 2500, points: 500, gold: 25, done: false },
        { id: 'meds_2_days', parentQuestId: 'take_meds_daily', threshold: 2, text: "Took meds 2 days in a row", xp: 150, points: 30, gold: 2, done: false },
        { id: 'meds_4_days', parentQuestId: 'take_meds_daily', threshold: 4, text: "Took meds 4 days in a row", xp: 300, points: 60, gold: 4, done: false },
        { id: 'meds_7_days', parentQuestId: 'take_meds_daily', threshold: 7, text: "Took meds 1 week in a row", xp: 600, points: 120, gold: 8, done: false },
        { id: 'meds_14_days', parentQuestId: 'take_meds_daily', threshold: 14, text: "Took meds 2 weeks in a row", xp: 1200, points: 240, gold: 15, done: false },
        { id: 'meds_30_days', parentQuestId: 'take_meds_daily', threshold: 30, text: "Took meds 1 month in a row", xp: 3000, points: 600, gold: 30, done: false }
      ],
      shopWeapons: [
          { 
            id: 'wooden_sword', name: "Wooden Sword", cost: 50, currency: "silver", requiredRank: 0, // F-rank (index 0)
            icon: 'images/weapon_wood_sword_icon.png', 
            image: 'images/weapon_wood_sword_large.png', 
            ability: "A simple sword. Use it wisely."
          },
          { 
            id: 'stone_dagger', name: "Stone Dagger", cost: 100, currency: "silver", requiredRank: 1, // E-rank (index 1)
            icon: 'images/weapon_stone_dagger_icon.png', 
            image: 'images/weapon_stone_dagger_large.png', 
            ability: "A rough blade. Good for quick work."
          },
          { 
            id: 'copper_spear', name: "Copper Spear", cost: 200, currency: "silver", requiredRank: 2, // D-rank (index 2)
            icon: 'images/weapon_copper_spear_icon.png', 
            image: 'images/weapon_copper_spear_large.png', 
            ability: "A basic spear. Offers decent reach."
          },
          { 
            id: 'iron_axe', name: "Iron Axe", cost: 400, currency: "silver", requiredRank: 3, // C-rank (index 3)
            icon: 'images/weapon_iron_axe_icon.png', 
            image: 'images/weapon_iron_axe_large.png', 
            ability: "A sturdy axe. Great for chopping tasks."
          },
          { 
            id: 'steel_sword', name: "Steel Sword", cost: 5, currency: "gold", requiredRank: 4, // B-rank (index 4)
            icon: 'images/weapon_steel_sword_icon.png', 
            image: 'images/weapon_steel_sword_large.png', 
            ability: "A balanced sword. A true adventurer's companion."
          },
          { 
            id: 'silver_bow', name: "Silver Bow", cost: 10, currency: "gold", requiredRank: 5, // A-rank (index 5)
            icon: 'images/weapon_silver_bow_icon.png', 
            image: 'images/weapon_silver_bow_large.png', 
            ability: "An elegant bow. For precise strikes."
          },
          { 
            id: 'mythril_staff', name: "Mythril Staff", cost: 20, currency: "gold", requiredRank: 6, // S-rank (index 6)
            icon: 'images/weapon_mythril_staff_icon.png', 
            image: 'images/weapon_mythril_staff_large.png', 
            ability: "A magical staff. Channels inner power."
          },
          { 
            id: 'dragon_blade', name: "Dragon Blade", cost: 40, currency: "gold", requiredRank: 7, // S+-rank (index 7)
            icon: 'images/weapon_dragon_blade_icon.png', 
            image: 'images/weapon_dragon_blade_large.png', 
            ability: "Forged from dragon scales. The ultimate challenge awaits!"
          }
      ],
      // NIEUWE ITEMS DATA
      shopItems: [
        { id: 'diamond_item', name: "Diamond Item", cost: 100, currency: "points", rewardType: "gold", rewardAmount: 1, icon: 'Diament.png', ability: "Converts 100 Points into 1 Gold." },
        { id: 'mana_crystal', name: "Mana Crystal", cost: 10, currency: "points", rewardType: "silver", rewardAmount: 50, icon: 'ManaCrystal.png', ability: "Converts 10 Points into 50 Silver." },
        { id: 'advanced_mana_crystal', name: "Advanced Mana Crystal", cost: 1000, currency: "silver", rewardType: "xp", rewardAmount: 250, icon: 'AdvancedManaCrystal.png', ability: "Converts 1000 Silver into 250 XP." }
      ],
      ownedWeapons: [], 
      weaponCollectionCompleted: false 
    };

    // Het actuele data object dat tijdens de sessie wordt gebruikt.
    // Dit wordt geÃ¯nitialiseerd met de default data en dan overschreven/gemerged bij laden.
    let data = { ...defaultData }; // Start met een kopie van de default data

    let currentQuestType = null;
    let currentQuestIndex = null;

    // --- Core UI & Logic Functions ---

    function updateUI() {
      document.getElementById("level").textContent = data.level;
      document.getElementById("points").textContent = data.points;
      document.getElementById("gold").textContent = data.gold;
      document.getElementById("silver").textContent = data.silver;
      document.getElementById("shopPoints").textContent = data.points;
      document.getElementById("shopGold").textContent = data.gold;
      document.getElementById("shopSilver").textContent = data.silver;
      document.getElementById("rank").textContent = ranks[data.rank];

      let xpNeeded = data.level * 200;
      let percent = Math.min((data.xp / xpNeeded) * 100, 100);
      let fill = document.getElementById("xpFill");
      fill.style.width = percent + "%";
      fill.textContent = `${data.xp} / ${xpNeeded} XP`;

      // Daily Quests UI
      const dList = document.getElementById("dailyList");
      dList.innerHTML = "";
      data.dailyQuests.forEach((q, i) => {
        const li = document.createElement("li");
        li.textContent = `${q.text} (+${q.xp} XP / +${q.points}P)`;
        if (q.done) {
          li.classList.add('done');
        } else {
          li.onclick = () => openModal("daily", i);
        }
        dList.appendChild(li);
      });

      // Special Quests UI
      const sList = document.getElementById("specialList");
      sList.innerHTML = "";
      data.activeSpecials.forEach((q, i) => {
        const li = document.createElement("li");
        let daysLeftText = q.daysLeft > 0 ? ` â ${q.daysLeft} day${q.daysLeft !== 1 ? 's' : ''} left` : ' â Expired';
        li.textContent = `${q.text} (+${q.xp} XP / +${q.points}P)`;
        const spanDaysLeft = document.createElement('span');
        spanDaysLeft.textContent = daysLeftText;
        li.appendChild(spanDaysLeft);

        if (q.done || q.daysLeft <= 0) {
          li.classList.add('done');
        } else {
          li.onclick = () => openModal("special", i);
        }
        sList.appendChild(li);
      });

      // Streak Quests UI
      const streakList = document.getElementById("streakList");
      streakList.innerHTML = "";
      data.streakQuests.forEach((q, i) => {
          const li = document.createElement("li");
          li.textContent = `${q.text} (+${q.xp} XP / +${q.points}P / +${q.gold} Gold)`;
          if (q.done) {
              li.classList.add('done');
          } else {
              const parentStreak = data.dailyStreaks[q.parentQuestId];
              if (parentStreak) {
                  const currentProgress = parentStreak.current;
                  li.textContent += ` (Current streak: ${currentProgress}/${q.threshold} days)`;
              }
              li.style.cursor = 'default';
          }
          streakList.appendChild(li);
      });

      // Update Shop lijsten
      updateRankUpgradeList();
      updateItemShopList(); // NIEUW: Update Item Shop lijst
      updateRealLifeRewardsList();
      updateWeaponShopList(); // Update wapenshop lijst
      updateInventoryList(); // Update inventaris lijst

      // Update Info Table (for Rank Upgrades) - Zorgt dat de tabel in Info gevuld is als Info actief is
      updateRankUpgradeInfoTable();
    }

    function openModal(type, index) {
      const list = type === "daily" ? data.dailyQuests : data.activeSpecials;
      const q = list[index];

      if (q.done || (type === "special" && q.daysLeft <= 0)) {
        return;
      }

      currentQuestType = type;
      currentQuestIndex = index;
      document.getElementById("modalText").textContent = `Did you complete: ${q.text}?`;
      
      const questModal = document.getElementById("questModal");
      questModal.classList.add('active'); 
    }

    function confirmQuest(yes) {
      const questModal = document.getElementById("questModal");
      questModal.classList.remove('active'); 

      if (yes) {
        const list = currentQuestType === "daily" ? data.dailyQuests : data.activeSpecials;
        const q = list[currentQuestIndex];

        if (!q.done && !(currentQuestType === "special" && q.daysLeft <= 0)) {
          q.done = true;
          data.xp += Math.floor(q.xp * rankMultiplier[data.rank]);
          data.points += Math.floor(q.points * rankMultiplier[data.rank]);
          checkLevelUp();
          
          if (currentQuestType === "daily") {
              checkStreaks(q.id); 
          }

          updateUI();
          console.log(`Quest "${q.text}" completed!`);
        }
      }
    }

    function checkLevelUp() {
      let needed = data.level * 200;
      while (data.xp >= needed) {
        data.xp -= needed;
        data.level++;
        needed = data.level * 200;
        console.log(`Level Up! You are now Level ${data.level}!`);
      }
    }

    function showPage(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'shop') {
          showShopPage('mainShop');
      }
      if (id === 'generalInfo') {
          updateRankUpgradeInfoTable();
      }
      if (id === 'inventory') { // Wanneer naar inventaris genavigeerd
          updateInventoryList(); // Zorg dat de inventarislijst wordt bijgewerkt
      }
    }

    function showShopPage(id) {
        document.querySelectorAll('.shop-menu, .shop-submenu').forEach(sec => sec.classList.remove('active'));
        if (id === 'mainShop') {
            document.querySelector('.shop-menu').classList.add('active');
        } else {
            document.getElementById(id).classList.add('active');
        }
    }

    function getRankUpgradeCost(targetRankIndex) {
      const baseCost = 1000;
      return baseCost + (targetRankIndex * 1500);
    }

    function updateRankUpgradeList() {
        const rankList = document.getElementById("rankUpgradeList");
        rankList.innerHTML = "";

        for (let i = 0; i < ranks.length - 1; i++) {
            const currentRank = ranks[i];
            const nextRank = ranks[i + 1];
            const upgradeLevelRequired = rankLevelRequirements[i + 1];
            const upgradePointsCost = getRankUpgradeCost(i + 1);

            const li = document.createElement("li");
            li.innerHTML = `
                <span>Upgrade from <strong>${currentRank}</strong> to <strong>${nextRank}</strong> Rank:</span><br>
                <span>Requires: Level ${upgradeLevelRequired}, ${upgradePointsCost} Points</span>
            `;

            const buyButton = document.createElement("button");
            buyButton.textContent = "Buy";
            buyButton.onclick = () => buyRankUpgrade(i);
            
            if (data.rank === i) {
                if (data.level >= upgradeLevelRequired && data.points >= upgradePointsCost) {
                    buyButton.disabled = false;
                } else {
                    buyButton.disabled = true;
                }
            } else if (data.rank > i) {
                buyButton.textContent = "Achieved";
                buyButton.disabled = true;
                li.classList.add('done');
            } else {
                buyButton.textContent = "Locked";
                buyButton.disabled = true;
            }

            li.appendChild(buyButton);
            rankList.appendChild(li);
        }
    }

    function buyRankUpgrade(targetRankIndex) {
        if (data.rank !== targetRankIndex) {
            alert("You can only upgrade to your next immediate rank.");
            return;
        }

        const nextRankIndex = data.rank + 1;
        if (nextRankIndex >= ranks.length) {
            alert("You are already at the highest rank!");
            return;
        }

        const upgradeCost = getRankUpgradeCost(nextRankIndex);
        const requiredLevel = rankLevelRequirements[nextRankIndex];
        const nextRankName = ranks[nextRankIndex];

        if (data.level >= requiredLevel) {
            if (data.points >= upgradeCost) {
                data.points -= upgradeCost;
                data.rank++;
                alert(`Congratulations! You are now Rank ${nextRankName}!`);
                updateUI();
            } else {
                alert(`Not enough points! You need ${upgradeCost} points to upgrade to Rank ${nextRankName}.`);
            }
        } else {
            alert(`You need to reach Level ${requiredLevel} to upgrade to Rank ${nextRankName}.`);
        }
    }

    function updateRealLifeRewardsList() {
        const rewardsList = document.getElementById("realLifeRewardsList");
        rewardsList.innerHTML = "";

        data.realLifeRewards.forEach(reward => {
            const li = document.createElement("li");
            li.innerHTML = `<span>${reward.text}</span>`;

            const buyButton = document.createElement("button");
            if (reward.bought) {
                buyButton.textContent = "Claimed";
                buyButton.disabled = true;
                li.classList.add('done');
            } else {
                buyButton.textContent = `Buy (${reward.cost} Gold)`;
                buyButton.disabled = data.gold < reward.cost;
                buyButton.onclick = () => buyRealLifeReward(reward.id);
            }
            li.appendChild(buyButton);
            rewardsList.appendChild(li);
        });
    }

    function buyRealLifeReward(rewardId) {
        const reward = data.realLifeRewards.find(r => r.id === rewardId);

        if (reward && !reward.bought) {
            if (data.gold >= reward.cost) {
                data.gold -= reward.cost;
                reward.bought = true;
                alert(`Reward purchased! Enjoy your "${reward.text}"!`);
                updateUI();
            } else {
                alert(`Not enough Gold! You need ${reward.cost} Gold to buy "${reward.text}".`);
            }
        }
    }

    // --- NIEUW: Item Shop Logica ---
    function updateItemShopList() {
        const itemList = document.getElementById("itemList");
        itemList.innerHTML = "";

        defaultData.shopItems.forEach(item => {
            const li = document.createElement("li");
            li.classList.add('item-card'); // Toepassen van de kaart-styling class

            let costText = `${item.cost} ${item.currency}`;
            let rewardText = `Get: ${item.rewardAmount} ${item.rewardType.toUpperCase()}`; // Bijv. Get: 1 GOLD of Get: 250 XP
            
            li.innerHTML = `
                <img src="${item.icon}" alt="${item.name} icon" class="item-icon">
                <span class="item-card-name">${item.name}</span>
                <span class="item-card-cost-display">Cost: ${costText}</span>
                <span class="item-card-effect">${item.ability || rewardText}</span> `;

            const buyButton = document.createElement("button");
            buyButton.textContent = "Buy";
            
            // Controleer of de speler genoeg valuta heeft
            let hasEnoughCurrency = false;
            if (item.currency === "points") {
                hasEnoughCurrency = data.points >= item.cost;
            } else if (item.currency === "silver") {
                hasEnoughCurrency = data.silver >= item.cost;
            } else if (item.currency === "gold") {
                hasEnoughCurrency = data.gold >= item.cost;
            }

            buyButton.disabled = !hasEnoughCurrency; // Knop uitgeschakeld indien geen valuta
            buyButton.onclick = () => buyItem(item.id); // Roep buyItem functie aan
            
            li.appendChild(buyButton);
            itemList.appendChild(li);
        });
    }

    function buyItem(itemId) {
        const item = defaultData.shopItems.find(i => i.id === itemId);

        if (!item) {
            alert("This item is not available.");
            return;
        }

        // Valuta checks
        let hasEnoughCurrency = false;
        if (item.currency === "points") {
            hasEnoughCurrency = data.points >= item.cost;
        } else if (item.currency === "silver") {
            hasEnoughCurrency = data.silver >= item.cost;
        } else if (item.currency === "gold") {
            hasEnoughCurrency = data.gold >= item.cost;
        }

        if (!hasEnoughCurrency) {
            alert(`Not enough ${item.currency}! You need ${item.cost} ${item.currency} to buy the ${item.name}.`);
            return;
        }

        // Koop het item
        if (item.currency === "points") {
            data.points -= item.cost;
        } else if (item.currency === "silver") {
            data.silver -= item.cost;
        } else if (item.currency === "gold") {
            data.gold -= item.cost;
        }

        // Beloning van item
        if (item.rewardType === "xp") {
            data.xp += item.rewardAmount;
            checkLevelUp(); // Check for level up immediately
        } else if (item.rewardType === "points") {
            data.points += item.rewardAmount;
        } else if (item.rewardType === "gold") {
            data.gold += item.rewardAmount;
        } else if (item.rewardType === "silver") {
            data.silver += item.rewardAmount;
        }
        
        alert(`You bought the ${item.name}! You received ${item.rewardAmount} ${item.rewardType.toUpperCase()}!`);
        updateUI();
    }


    // --- Weapon Shop Logica ---

    function updateWeaponShopList() {
        const weaponList = document.getElementById("weaponList");
        weaponList.innerHTML = "";

        defaultData.shopWeapons.forEach(weapon => { // Gebruik defaultData.shopWeapons voor de volledige lijst
            const li = document.createElement("li");
            li.classList.add('weapon-card'); // Toepassen van de kaart-styling class
            const alreadyOwned = data.ownedWeapons.includes(weapon.id); // Controleer of al in bezit

            let costText = `${weapon.cost} ${weapon.currency}`;
            
            li.innerHTML = `
                <img src="${weapon.icon}" alt="${weapon.name} icon" class="weapon-item-icon">
                <span class="weapon-card-name">${weapon.name}</span>
                <span class="weapon-card-rank">Rank: ${ranks[weapon.requiredRank]}</span>
                <span class="weapon-card-cost">Cost: ${costText}</span>
                <span class="weapon-card-ability">${weapon.ability}</span>
            `;

            const buyButton = document.createElement("button");
            if (alreadyOwned) {
                buyButton.textContent = "Owned";
                buyButton.disabled = true;
                li.classList.add('done'); // Markeer als bezit
            } else {
                buyButton.textContent = "Buy";
                // Bepaal of de speler genoeg valuta heeft EN de vereiste rank heeft
                const hasEnoughCurrency = (weapon.currency === "silver" && data.silver >= weapon.cost) ||
                                          (weapon.currency === "gold" && data.gold >= weapon.cost);
                const hasRequiredRank = data.rank >= weapon.requiredRank;

                buyButton.disabled = !hasEnoughCurrency || !hasRequiredRank; // Knop uitgeschakeld indien geen valuta of rank
                buyButton.onclick = () => buyWeapon(weapon.id); // Roep buyWeapon functie aan
            }
            li.appendChild(buyButton);
            weaponList.appendChild(li);
        });
    }

    function buyWeapon(weaponId) {
        const weapon = defaultData.shopWeapons.find(w => w.id === weaponId); // Gebruik defaultData om basis info te krijgen
        const alreadyOwned = data.ownedWeapons.includes(weaponId);

        if (!weapon || alreadyOwned) {
            alert("This weapon is not available or already owned.");
            return;
        }

        // Valuta en rank checks
        const hasEnoughCurrency = (weapon.currency === "silver" && data.silver >= weapon.cost) ||
                                  (weapon.currency === "gold" && data.gold >= weapon.cost);
        const hasRequiredRank = data.rank >= weapon.requiredRank;

        if (!hasRequiredRank) {
            alert(`You need to be Rank ${ranks[weapon.requiredRank]} or higher to buy the ${weapon.name}.`);
            return;
        }

        if (!hasEnoughCurrency) {
            alert(`Not enough ${weapon.currency}! You need ${weapon.cost} ${weapon.currency} to buy the ${weapon.name}.`);
            return;
        }

        // Koop het wapen
        if (weapon.currency === "silver") {
            data.silver -= weapon.cost;
        } else { // gold
            data.gold -= weapon.cost;
        }
        data.ownedWeapons.push(weapon.id); 

        // Beloningen bij aankoop zijn nu NIET voor individuele wapens, enkel voor collectie
        // alert(`You bought the ${weapon.name}!`); // Alleen koopbevestiging

        // Controleer of alle wapens verzameld zijn
        if (!data.weaponCollectionCompleted && data.ownedWeapons.length === defaultData.shopWeapons.length) { 
            data.weaponCollectionCompleted = true;
            const bonusXP = 2000;    // Zoals besproken
            const bonusPoints = 500; // Zoals besproken
            const bonusGold = 100;   // Zoals besproken
            const bonusSilver = 2000; // Zilver bonus
            data.xp += bonusXP;
            data.points += bonusPoints;
            data.gold += bonusGold;
            data.silver += bonusSilver; 
            alert(`CONGRATULATIONS! You have collected ALL weapons! You received a grand bonus of ${bonusXP} XP, ${bonusPoints} Points, ${bonusGold} Gold, and ${bonusSilver} Silver!`);
        } else {
             alert(`You bought the ${weapon.name}!`); // Melding ook als collectie niet compleet is
        }

        checkLevelUp();
        updateUI();
    }

    // --- Inventaris Logica ---

    function updateInventoryList() {
        const inventoryList = document.getElementById("inventoryList");
        inventoryList.innerHTML = "";

        if (data.ownedWeapons.length === 0) {
            inventoryList.innerHTML = "<li class='panel'>No weapons in your inventory yet. Visit the Weapon Shop!</li>";
            return;
        }

        data.ownedWeapons.forEach(weaponId => {
            const weapon = defaultData.shopWeapons.find(w => w.id === weaponId); 
            if (weapon) {
                const li = document.createElement("li");
                li.classList.add('weapon-card'); 
                li.innerHTML = `
                    <img src="${weapon.icon}" alt="${weapon.name} icon" class="weapon-item-icon">
                    <span class="weapon-card-name">${weapon.name}</span>
                    <span class="weapon-card-rank">Rank: ${ranks[weapon.requiredRank]}</span>
                    <span class="weapon-card-ability">${weapon.ability}</span>
                `;
                inventoryList.appendChild(li);
            }
        });
    }

    // --- Streak Quest Logica ---

    function checkStreaks(completedDailyQuestId) {
        const today = new Date().toDateString();

        if (completedDailyQuestId === 'brush_teeth_1' || completedDailyQuestId === 'brush_teeth_2') {
            const brushStreak = data.dailyStreaks['brush_teeth_daily'];
            if (brushStreak.lastCompletionDate !== today) {
                updateSingleStreak('brush_teeth_daily', today);
            }
        }

        if (completedDailyQuestId === 'take_meds') {
            updateSingleStreak('take_meds_daily', today);
        }

        data.streakQuests.forEach(streakQuest => {
            if (!streakQuest.done && data.dailyStreaks[streakQuest.parentQuestId] && data.dailyStreaks[streakQuest.parentQuestId].current >= streakQuest.threshold) {
                streakQuest.done = true;
                data.xp += streakQuest.xp;
                data.points += streakQuest.points;
                data.gold += streakQuest.gold;
                checkLevelUp();
                alert(`STREAK COMPLETED! You earned a reward for "${streakQuest.text}"! (+${streakQuest.xp} XP / +${streakQuest.points} P / +${streakQuest.gold} Gold)`);
                console.log(`Streak Quest "${streakQuest.text}" completed!`);
            }
        });
    }

    function updateSingleStreak(streakKey, today) {
        let streak = data.dailyStreaks[streakKey];
        if (!streak) {
            streak = { current: 0, lastCompletionDate: null };
            data.dailyStreaks[streakKey] = streak;
        }

        const lastDate = streak.lastCompletionDate ? new Date(streak.lastCompletionDate) : null;
        const currentDate = new Date(today);

        if (lastDate && currentDate.toDateString() === lastDate.toDateString()) {
            return;
        }

        if (lastDate && (currentDate.getTime() - lastDate.getTime()) === (24 * 60 * 60 * 1000)) {
            streak.current++;
        } else if (lastDate && (currentDate.getTime() - lastDate.getTime()) > (24 * 60 * 60 * 1000)) {
            streak.current = 1;
        } else {
            streak.current = 1;
        }
        streak.lastCompletionDate = today;
        console.log(`${streakKey} streak updated to: ${streak.current}`);
    }


    function saveProgress() {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'progress.json';
      a.click();
      URL.revokeObjectURL(a.href);
      console.log("Progress saved to progress.json");
    }

    function loadProgress(e) {
      const file = e.target.files[0];
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const loadedData = JSON.parse(ev.target.result);

          // 1. Maak een NIEUW data object gebaseerd op de actuele (default) structuur.
          // Dit garandeert dat alle nieuwe velden aanwezig zijn met hun standaardwaarden.
          let currentSessionData = { ...defaultData }; 

          // 2. Overwrite primitieve waarden en directe kopieÃ«n van geladen data
          currentSessionData.level = loadedData.level !== undefined ? loadedData.level : defaultData.level;
          currentSessionData.xp = loadedData.xp !== undefined ? loadedData.xp : defaultData.xp;
          currentSessionData.points = loadedData.points !== undefined ? loadedData.points : defaultData.points;
          currentSessionData.gold = loadedData.gold !== undefined ? loadedData.gold : defaultData.gold;
          currentSessionData.silver = loadedData.silver !== undefined ? loadedData.silver : defaultData.silver; 
          currentSessionData.rank = loadedData.rank !== undefined ? loadedData.rank : defaultData.rank;
          currentSessionData.lastDailyReset = loadedData.lastDailyReset || defaultData.lastDailyReset;
          currentSessionData.lastSpecialReset = loadedData.lastSpecialReset || defaultData.lastSpecialReset;
          currentSessionData.weaponCollectionCompleted = loadedData.weaponCollectionCompleted !== undefined ? loadedData.weaponCollectionCompleted : defaultData.weaponCollectionCompleted;
          
          // 3. Functie om arrays met ID's te mergen: behoud defaults, update state van geladen items
          // En voeg nieuwe items toe die in de geladen data zitten, maar niet in de defaults (voor backwards compatibility)
          const mergeArrayItems = (defaultArray, loadedArray, idKey = 'id') => {
              const merged = defaultArray.map(defaultItem => {
                  const loadedItem = (loadedArray || []).find(li => li[idKey] === defaultItem[idKey]);
                  return loadedItem ? { ...defaultItem, ...loadedItem } : defaultItem; 
              });
              (loadedArray || []).forEach(loadedItem => { 
                  if (!merged.some(m => m[idKey] === loadedItem[idKey])) {
                      merged.push(loadedItem);
                  }
              });
              return merged;
          };

          currentSessionData.dailyQuests = mergeArrayItems(defaultData.dailyQuests, loadedData.dailyQuests);
          currentSessionData.realLifeRewards = mergeArrayItems(defaultData.realLifeRewards, loadedData.realLifeRewards);
          currentSessionData.streakQuests = mergeArrayItems(defaultData.streakQuests, loadedData.streakQuests);
          currentSessionData.shopWeapons = mergeArrayItems(defaultData.shopWeapons, loadedData.shopWeapons);
          currentSessionData.shopItems = mergeArrayItems(defaultData.shopItems, loadedData.shopItems); // NIEUW: Merge shopItems


          // 4. Speciale afhandeling voor activeSpecials (worden toch gereset/herkozen)
          currentSessionData.activeSpecials = loadedData.activeSpecials || []; 

          // 5. Speciale afhandeling voor dailyStreaks objecten
          currentSessionData.dailyStreaks = { ...defaultData.dailyStreaks }; 
          if (loadedData.dailyStreaks) {
              for (const key in defaultData.dailyStreaks) { 
                  if (loadedData.dailyStreaks[key]) {
                      currentSessionData.dailyStreaks[key] = {
                          current: loadedData.dailyStreaks[key].current,
                          lastCompletionDate: loadedData.dailyStreaks[key].lastCompletionDate
                      };
                  }
              }
              for (const key in loadedData.dailyStreaks) { 
                  if (!currentSessionData.dailyStreaks[key]) {
                      currentSessionData.dailyStreaks[key] = loadedData.dailyStreaks[key];
                  }
              }
          }

          // 6. ownedWeapons kan direct worden overgenomen, want het is een lijst van ID's
          currentSessionData.ownedWeapons = loadedData.ownedWeapons || [];


          // Overwrite het globale data object met het nieuw samengevoegde object
          data = currentSessionData;

          console.log("Progress successfully loaded!");
          performDailyAndSpecialResets(); 
          updateUI(); 
        } catch (error) {
          alert("Error loading progress: Invalid file or data format. Please select a valid .json file.");
          console.error("Loading error:", error);
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    // --- Info Table (Rank Upgrades) Logic ---
    function updateRankUpgradeInfoTable() {
        const generalInfoSection = document.getElementById("generalInfo");
        if (!generalInfoSection || !generalInfoSection.classList.contains('active')) {
            return;
        }

        const tableBody = document.getElementById("rankUpgradeInfoTableBody");
        if (!tableBody) return; 
        tableBody.innerHTML = "";

        for (let i = 0; i < ranks.length - 1; i++) {
            const currentRank = ranks[i];
            const nextRank = ranks[i + 1];
            const requiredLevel = rankLevelRequirements[i + 1];
            const pointsCost = getRankUpgradeCost(i + 1);

            const row = tableBody.insertRow();
            row.insertCell().textContent = currentRank;
            row.insertCell().textContent = nextRank;
            row.insertCell().textContent = `Level ${requiredLevel}`;
            row.insertCell().textContent = `${pointsCost} Points`;
        }
    }


    // --- Reset Functies ---

    function checkDailyReset() {
      const today = new Date().toDateString();
      if (data.lastDailyReset !== today) {
        data.dailyQuests.forEach(q => q.done = false);
        data.lastDailyReset = today;
        
        for (const key in data.dailyStreaks) {
            const streak = data.dailyStreaks[key];
            if (streak.lastCompletionDate) {
                const lastDate = new Date(streak.lastCompletionDate);
                const currentDate = new Date(today);
                const diffTime = currentDate.getTime() - lastDate.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays > 1) {
                    streak.current = 0;
                    console.log(`Streak for ${key} broken. Reset to 0.`);
                }
            } else {
                streak.current = 0;
            }
        }
        console.log("Daily quests have been reset to undone!");
      }
    }

    function resetSpecials() {
      const today = new Date();
      const lastSpecialResetDate = new Date(data.lastSpecialReset);

      const diffTime = Math.abs(today.getTime() - lastSpecialResetDate.getTime());
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays >= 3 || data.activeSpecials.length === 0) {
        data.activeSpecials = [];
        const availableQuests = [...data.allSpecialQuests];
        for (let i = availableQuests.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [availableQuests[i], availableQuests[j]] = [availableQuests[j], availableQuests[i]];
        }

        for (let i = 0; i < 5; i++) {
          if (availableQuests.length === 0) break;
          const newQuest = { ...availableQuests.shift(), daysLeft: 3, done: false };
          data.activeSpecials.push(newQuest);
        }

        data.lastSpecialReset = today.toDateString();
        console.log("Special quests have been fully reset and 5 new ones selected!");

      } else if (diffDays > 0) {
        data.activeSpecials.forEach(q => {
          if (!q.done && q.daysLeft > 0) {
            q.daysLeft -= diffDays;
          }
        });
        data.activeSpecials = data.activeSpecials.filter(q => q.daysLeft > 0 || q.done);
        console.log(`Special quests days left decremented by ${diffDays} day(s).`);
      }
    }

    function performDailyAndSpecialResets() {
      checkDailyReset();
      resetSpecials();
    }

    // --- Initialisatie ---

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("rank").textContent = ranks[data.rank];
        performDailyAndSpecialResets();
        updateUI(); 
        showPage('status'); 
    });
  </script>
</body>
</html>
